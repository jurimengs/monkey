<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="PermissionField">
    <!-- 通过email查找用户 -->
    <sql id="findEntityListByRoleId" isRead="true">
		<![CDATA[
		SELECT pf.id, pf.table_name, pf.field_name, pf.type, pf.auth_flag, pf.company_id, 
		    pf.create_date, pf.create_uid, pf.update_date, pf.update_uid 
		    FROM wec_role_permission rp 
			left join wec_permission_field pf on rp.permission_id = pf.id
			where rp.company_id = :companyId and pf.id <> ''
			
			<#if roleIdList?? && roleIdList?size gt 0>
				AND rp.role_id in  (
					<#list roleIdList as id>
						'${id}'
						<#if id_has_next>,</#if>
					</#list>
				)
			</#if>
			<#if tableName?? && tableName?length gt 0>
				AND table_name = :tableName
			</#if>
		]]>
    </sql>

    <sql id="findEntityByUniqueKey" isRead="true">
		<![CDATA[
		SELECT pf.id, pf.table_name, pf.field_name, pf.type, pf.auth_flag, pf.company_id, pf.create_date, pf.create_uid, pf.update_date, pf.update_uid
		from wec_permission_field pf
		where pf.company_id = :companyId and pf.table_name = :tableName and pf.field_name = :fieldName and pf.type = :type
		]]>
    </sql>

    <sql id="findAuthOfField" isRead="true">
		<![CDATA[
		select pf.type from wec_permission_field pf 
		join wec_role_permission rp on pf.id = rp.permission_id
		where pf.table_name = :tableName 
		and pf.company_id = :companyId 
		and pf.field_name = :fieldName 
		and rp.role_id in (:roleIdList)
		order by pf.type desc
		]]>
    </sql>

    <sql id="findByTableNameAndFieldAndRoleId" isRead="true">
		<![CDATA[
		select rp.* from wec_permission_field pf 
		join wec_role_permission rp on pf.id = rp.permission_id
		where pf.table_name = :tableName 
		and pf.company_id = :companyId 
		and pf.field_name = :fieldName 
		and rp.role_id = :roleId
		]]>
    </sql>

    <sql id="findFieldsWithAuthByTableName" isRead="true">
		<![CDATA[
		select a.field_name as columnName, a.field_cn as columnComment, a.style as dataType, pf.type, rp.create_time as createTime
		from t_table_fieldbook a 
		left join wec_permission_field pf on pf.field_name = a.field_name
		left join wec_role_permission rp on rp.permission_id = pf.id
		where a.table_name = :tableName and pf.company_id = :companyId
        <#if roleIdList?? && roleIdList?size gt 0>
            AND rp.role_id in  (:roleIdList)
        </#if>
		]]>
    </sql>

    <sql id="findFieldsByBizTypeId" isRead="true">
		<![CDATA[
		select a.table_name as tableName, a.field_name as columnName, a.field_cn as columnComment, a.style as dataType
		from t_tables t
        join t_table_fieldbook a on t.table_name = a.table_name
		where t.biz_type_id = :bizTypeId and t.type = 0
        ORDER BY t.id
		]]>
    </sql>

    <sql id="findExtTableFieldsByBizTypeId" isRead="true">
		<![CDATA[
        select DISTINCT fcr.`table` as tableName, fcr.column as columnName, f.name as columnComment, f.style as dataType
        from t_ext_fieldbook_company_ref fcr
        join t_ext_fieldbook f on fcr.fid = f.fid
        join t_tables t on t.table_name = fcr.`table`
        where t.biz_type_id = :bizTypeId and fcr.company_id = :companyId AND t.type = 1 AND t.`status` = 0
		]]>
    </sql>

</sqlMap>
