<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="HouqinSushe">
    <sql id="findByParam" isRead="true">
        <![CDATA[
        SELECT
        t.id,
        t.`status`,
        t.`name`,
        t.address,
        t.yajin,
        t.rent,
        t.begin_date beginDate,
        t.end_date endDate,
        t.goods,
        GROUP_CONCAT(DISTINCT o.id) organId,
        t.company_id companyId,
        t.lessee,
        w.user_name updateUserName,
        t.update_date updateDate,
        GROUP_CONCAT(DISTINCT o.organ_name) organNames
            <#if selfFields??  && selfFields?size gt 0>
				,
                <#list selfFields as selfField>
           		 	ext.${selfField}
                    <#if selfField_has_next>,</#if>
                </#list>
            </#if>
        FROM
        t_houqin_sushe t
        LEFT JOIN t_houqin_sushe_range thsr ON t.id = thsr.sushe_id
        LEFT JOIN t_organ o ON o.id = thsr.organ_id
        left join wec_user w on w.id=t.update_uid
        where t.company_id=:companyId
        and t.status=0
            <#if keyword?? && keyword?length gt 0>
                    and t.name like concat('%',:keyword,'%')
            </#if>
            <#if organPaths?? && organPaths?length gt 0>
                    AND o.organ_paths like CONCAT (:organPaths,'%')
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>
            <#if tabId?? && tabId?length gt 0>
                <#if tabId = '2'>
                        AND t.has_chuangwei=0
                <#elseif tabId = '3'>
                        AND t.has_chuangwei=1
                <#elseif tabId='4'>
                        and end_date>=CURDATE()
                        and end_date<=date_sub(CURDATE(), INTERVAL -30 DAY)
                </#if>
            </#if>
            <#if functions??  && functions?size gt 0>
				and (
                <#list functions as thisfunc>
                    <#if thisfunc??  && thisfunc?size gt 0>
	           		 	(
                        <#list thisfunc as selffunc>
                            ${selffunc.sqlStr}
                            <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                                <#if selffunc.funcType = 0>
	           		 			 			<
                                </#if>
                                <#if selffunc.funcType = 1>
	           		 			 			=
                                </#if>
                                <#if selffunc.funcType = 2>
	           		 			 			>
                                </#if>
                            <#else>
	           		 			 	 like
                            </#if>
	           		 			'${selffunc.funcValue}'
                            <#if selffunc_has_next> and</#if>
                        </#list>
           		 		)
                        <#if thisfunc_has_next> or </#if>
                    </#if>
                </#list>
                )
            </#if>
        group by t.id
        ]]>
    </sql>


    <sql id="queryDetailCount" isRead="true">
        <![CDATA[
        SELECT
        t.sushe_id id,
        count(DISTINCT t.id) totalFangjianCount,
        count(1) totalChuangWeiCount,
        sum(if(thc.used=0,1,0)) usedCount,
        sum(if(thc.used=1,1,0)) unusedCount
        FROM
        t_houqin_sushe_fangjian t
        LEFT JOIN t_houqin_chuangwei thc ON t.id = thc.fangjian_id
        WHERE
        t.`status` = 0
        AND thc.`status` = 0
        AND t.sushe_id in(:ids)
        group by t.sushe_id
        ]]>
    </sql>

    <sql id="queryCount" isRead="true">
        <![CDATA[
        SELECT
        count(1) totalChuangWeiCount,
        ifnull(sum(IF(tt.has_chuangwei = 0, 1, 0)),0) usedCount,
        ifnull(sum(IF(tt.has_chuangwei = 1, 1, 0)),0) unusedCount,
        ifnull(sum(

        IF (
        tt.end_date >= CURDATE()
        AND tt.end_date <= date_sub(CURDATE(), INTERVAL -30 DAY),
        1,
        0
        )
        ),0) expire30Count
        FROM
        t_houqin_sushe tt
        WHERE
        tt.id IN (
        SELECT
        DISTINCT t.id
        FROM
        t_houqin_sushe t
        LEFT JOIN t_houqin_sushe_range thsr ON t.id = thsr.sushe_id
        LEFT JOIN t_organ o ON o.id = thsr.organ_id
        WHERE
        t.`status` = 0
         <#if keyword?? && keyword?length gt 0>
                    and t.name like concat('%',:keyword,'%')
         </#if>
            <#if organPaths?? && organPaths?length gt 0>
                    AND o.organ_paths like CONCAT (:organPaths,'%')
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>
         <#if functions??  && functions?size gt 0>
				and (
             <#list functions as thisfunc>
                 <#if thisfunc??  && thisfunc?size gt 0>
	           		 	(
                     <#list thisfunc as selffunc>
                         ${selffunc.sqlStr}
                         <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                             <#if selffunc.funcType = 0>
	           		 			 			<
                             </#if>
                             <#if selffunc.funcType = 1>
	           		 			 			=
                             </#if>
                             <#if selffunc.funcType = 2>
	           		 			 			>
                             </#if>
                         <#else>
	           		 			 	 like
                         </#if>
	           		 			'${selffunc.funcValue}'
                         <#if selffunc_has_next> and</#if>
                     </#list>
           		 		)
                     <#if thisfunc_has_next> or </#if>
                 </#if>
             </#list>
             )
         </#if>
        )
        ]]>
    </sql>

    <!--根据宿舍ID查询房间信息-->
    <sql id="queryFangjianBySusheId" isRead="true">
        <![CDATA[
        SELECT
        t.id fangJianId,
        t.room_name roomName,
        t.sushe_id susheId,
        t.total_chuangwei totalChuangwei,
        t.used_chuangwei usedChuangwei
        FROM
        t_houqin_sushe_fangjian t
        WHERE
        t.sushe_id = :id
        AND t.`status` = 0
        ]]>
    </sql>

    <!--根据ID查询宿舍信息-->
    <sql id="queryById" isRead="true">
        <![CDATA[
        SELECT
        t.id,
        t.organ_id organId,
        t.`name` 'name',
        t.begin_date beginDate,
        t.end_date endDate,
        t.rent,
        t.yajin,
        t.address,
        t.goods,
        t.phone,
        t.lessee,
        t.cheng_dan_type chengDanType,
        t.remark
        FROM
        t_houqin_sushe t
        where t.id=:id
        ]]>
    </sql>

    <!--根据宿舍Id查询该宿舍下所有的房间-->
    <sql id="queryFangjianListBySusheId" isRead="true">
        <![CDATA[
        select *from t_houqin_sushe_fangjian where sushe_id=:susheId and `status`=0
        ]]>
    </sql>


    <!--删除宿舍房间-->
    <sql id="deleteFangjianById">
        <![CDATA[
        UPDATE t_houqin_sushe_fangjian
        SET `status` = 5
        WHERE
        id =:id
        ]]>
    </sql>


    <!--根据房间ID查询房间内所有床位-->
    <sql id="queryChuangweiByFangjianId" isRead="true">
        <![CDATA[
        SELECT
        *
        FROM
        t_houqin_chuangwei
        WHERE
        fangjian_id =:fangjianId
        and `status`=0
        order by chuangwei_no desc
        ]]>
    </sql>


    <!--根据房间ID查询房间内所有入住人员-->
    <sql id="getSusheRuzhuPerson" isRead="true">
        <![CDATA[
        SELECT
        u.id,
        u.user_name AS 'name'
        FROM
        t_houqin_sushe_fangjian t
        LEFT JOIN t_houqin_chuangwei thc ON t.id = thc.fangjian_id
        LEFT JOIN wec_user u ON u.id = thc.user_id
        WHERE
        t.sushe_id=:susheId
        AND t.`status` = 0
        AND thc.`status` = 0
        AND thc.user_id IS NOT NULL
        ]]>
    </sql>

    <!--获取宿舍寝室长记录-->
    <sql id="getSusheAdminRecord" isRead="true">
        <![CDATA[
        SELECT
        t.id,
        DATE_FORMAT(t.begin_date, '%Y-%m-%d') beginDate,
        DATE_FORMAT(t.end_date, '%Y-%m-%d') endDate,
        t.butie_amount butieAmount,
        t.user_id userId,
        w.organ_id organId,
        w.user_name userName,
        t.sushe_id susheId,
        t.status
        FROM
        t_houqin_sushe_admin t
        LEFT JOIN wec_user w ON t.user_id = w.id
        WHERE
        t.sushe_id =:susheId
            <#if keyword?? && keyword?length gt 0>
              AND w.user_name LIKE CONCAT('%', :keyword, '%')
            </#if>
        ORDER BY
        begin_date DESC
        ]]>
    </sql>

    <!--查询当前寝室长-->
    <sql id="queryCurrentAdmin" isRead="true">
        <![CDATA[
        SELECT
        t.*
        FROM
        t_houqin_sushe_admin t
        WHERE
        t.sushe_id =:susheId
        AND t.`status` = 0
        AND t.end_date is null
        order by t.begin_date desc
        ]]>
    </sql>

    <!--查询宿舍所有床位信息-->
    <sql id="getAllchuangwei" isRead="true">
        <![CDATA[
        SELECT
        t.id fangjianId,
        thc.id chuangweiId,
        t.room_name fangjianName,
        thc.chuangwei_name chuangweiName,
        thc.used,
        w.id userId,
        w.organ_id organId,
        w.user_name userName,
        w.emp_no empNo,
        tg.gangwei_name gangweiName,
        thc.ruzhu_id tuzhuId,
        ths.begin_date beginDate,
        ths.end_date endDate
        FROM
        t_houqin_sushe_fangjian t
        LEFT JOIN t_houqin_chuangwei thc ON t.id = thc.fangjian_id
        LEFT JOIN t_houqin_sushe_ruzhu_record ths ON ths.id = thc.ruzhu_id
        AND thc.ruzhu_id IS NOT NULL
        LEFT JOIN wec_user w ON thc.user_id = w.id
        LEFT JOIN t_gangwei tg ON tg.id = w.gangwei_id
        AND w.gangwei_id IS NOT NULL
        WHERE
        t.`status` = 0
        AND thc.`status` = 0
        AND t.sushe_id=:susheId
        order by t.room_name,thc.chuangwei_no
        ]]>
    </sql>


    <!--查询房间已使用的床位数-->
    <sql id="queryUsedCount" isRead="true">
        <![CDATA[
        SELECT
        count(1)
        FROM
        t_houqin_chuangwei t
        WHERE
        t.fangjian_id =:fangjianId
        AND t.`status` = 0
        and t.used=0
        ]]>
    </sql>


    <!--查询当前寝室长-->
    <sql id="getCurrentAdmin" isRead="true">
        <![CDATA[
        SELECT
        t.id,
        t.user_id userId,
        w.user_name userName,
        DATE_FORMAT(t.begin_date, '%Y-%m-%d') beginDate,
        t.butie_amount butieAmount
        FROM
        t_houqin_sushe_admin t
        LEFT JOIN wec_user w ON w.id = t.user_id
        WHERE
        t.sushe_id =:susheId
        AND t.`status` = 0
        AND t.end_date IS NULL
        ORDER BY
        t.begin_date DESC
        LIMIT 1
        ]]>
    </sql>


    <!--查询可用宿舍-->
    <sql id="queryCanUseSushe" isRead="true">
        <![CDATA[

        SELECT
        ths.id susheId,ths.`name` susheName
        FROM
        t_houqin_sushe_range t
        LEFT JOIN t_houqin_sushe ths ON t.sushe_id = ths.id
        LEFT JOIN t_houqin_sushe_fangjian thsf ON thsf.sushe_id = ths.id
        LEFT JOIN t_houqin_chuangwei thc ON thc.fangjian_id = thsf.id
        WHERE
        ths.`status` = 0
        AND thsf.`status` = 0
        AND thc.`status` = 0
        AND thc.used = 1
        and t.organ_id=:organId
        <#if keyword?? && keyword?length gt 0>
              AND ths.name LIKE CONCAT('%', :keyword, '%')
        </#if>
        group by ths.id

        ]]>
    </sql>
    <!--查询可用房间-->
    <sql id="queryCanUseFangjian" isRead="true">
        <![CDATA[
        SELECT
        thsf.id fangjianId,
        thsf.room_name fangjianName
        FROM
        t_houqin_sushe_fangjian thsf
        LEFT JOIN t_houqin_chuangwei thc ON thsf.id = thc.fangjian_id
        WHERE
        thsf.sushe_id =:susheId
        AND thsf.`status` = 0
        AND thc.`status` = 0
        AND thc.ruzhu_id IS NULL
        GROUP BY
        thsf.id
        ]]>
    </sql>

    <!--查询可用床位-->
    <sql id="queryCanUseChuangwei" isRead="true">
        <![CDATA[
        SELECT
        t.chuangwei_name chuangweiName,
        t.id chuangweiId
        FROM
        t_houqin_chuangwei t
        WHERE
        t.fangjian_id =:fangjianId
        AND t.`status` = 0
        AND t.ruzhu_id IS NULL
        ]]>
    </sql>

    <!--根据宿舍名查询宿舍-->
    <sql id="queryByName" isRead="true">
        <![CDATA[
        SELECT
        *
        FROM
        t_houqin_sushe t
        WHERE
        t.`name` =:name
        AND t.company_id =:companyId
        ]]>
    </sql>


    <!--查询宿舍入住人数-->
    <sql id="queryHasUsedCount" isRead="true">
        <![CDATA[
        SELECT
        count(1) usedCount
        FROM
        t_houqin_sushe_fangjian t
        LEFT JOIN t_houqin_chuangwei thc ON t.id = thc.fangjian_id
        WHERE
        t.`status` = 0
        AND thc.`status` = 0
        and thc.used=0
        AND t.sushe_id =:id
        ]]>
    </sql>


    <!--查询宿舍空床位数-->
    <sql id="queryEmptyChuangweiCount" isRead="true">
        <![CDATA[
        SELECT
        count(1)
        FROM
        t_houqin_sushe_fangjian t
        LEFT JOIN t_houqin_chuangwei thc ON thc.fangjian_id = t.id
        WHERE
        t.`status` = 0
        AND thc.`status` = 0
        AND thc.used=1
        AND t.sushe_id =:susheId
        ]]>
    </sql>


    <!--查询用户入住中的记录-->
    <sql id="queryUserRuzhuCount" isRead="true">
        <![CDATA[
        SELECT
        count(1)
        FROM
        t_houqin_sushe_ruzhu_record t
        WHERE
        t.user_id =:userId
        AND t.end_date IS NULL
        ]]>
    </sql>


    <!--查询部门是否在宿舍使用部门范围内-->
    <sql id="queryRangeCount" isRead="true">
        <![CDATA[
        SELECT
        count(1)
        FROM
        t_houqin_sushe_range t
        WHERE
        t.sushe_id =:susheId
        AND t.organ_id =:organId
        ]]>
    </sql>

    <!--查询使用部门-->
    <sql id="queryOrganIds" isRead="true">
        <![CDATA[
        SELECT
        GROUP_CONCAT(t.organ_id) organId
        FROM
        t_houqin_sushe_range t
        WHERE
        t.sushe_id =:id
        ]]>
    </sql>
        <!--查询使用部门-->
    <sql id="queryOrganRange" isRead="true">
        <![CDATA[
        SELECT
      	tor.id organId,
        tor.organ_name organName
        FROM
        t_houqin_sushe_range t
         LEFT JOIN t_organ tor ON t.organ_id = tor.id
        WHERE
        t.sushe_id =:id
        ]]>
    </sql>
    
    

    <!--批量删除宿舍使用部门-->
    <sql id="batchDelete" >
        <![CDATA[
        delete from t_houqin_sushe_range  where sushe_id=:susheId
        ]]>
    </sql>


</sqlMap>
