<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="Gangwei">
    <sql id="getGangweiPage" isRead="true">
        <![CDATA[
		SELECT
			p.id,
			p.gangwei_name gangweiName,
			o.id organId,
			o.organ_name organName,
			p1.zhiwei_name zhiweiName,
			p.gangwei_code gangweiCode,
			p.parent_name parentName,
			p.zhideng_lower zhidengLower,
			p.zhideng_top zhidengTop,
			p.zhiji_lower zhijiLower,
			p.zhiji_top zhijiTop,
			zlt.`name` zhijiTopName,
			zll.`name` zhijiLowerName,
			'' lirenUser,
			COUNT(DISTINCT u.id) userCount,
			CASE
			WHEN COUNT(DISTINCT u.id) - p.member > '0' THEN
			COUNT(DISTINCT u.id) - p.member
			ELSE
			'0'
			END overbias,
			CASE
			WHEN p.member - COUNT(DISTINCT u.id) > '0' THEN
			p.member - COUNT(DISTINCT u.id)
			ELSE
			'0'
			END
		  	vacancy,
		  	p.update_date updateDate,
			u2.user_name updateUserName,
			p.member,
			GROUP_CONCAT(DISTINCT psr.skill_id) skill,
			GROUP_CONCAT(
				DISTINCT agr.agent_gangwei_id
			) agentGangweiId,
			GROUP_CONCAT(
				ag.gangwei_name
			) agentGangweiName,
			psr.skill_level_top_id skillLevelTopId,
			psr.skill_level_lower_id skillLevelLowerId,
			GROUP_CONCAT(
				agr.agent_level_id
			) agentLevelId,
			p.gangwei_desc gangweiDesc,
			p.gangwei_duty gangweiDuty
			<#if selfFields??  && selfFields?size gt 0>
			,
            	<#list selfFields as selfField>
           		 	te.${selfField}
           		 	<#if selfField_has_next>,</#if>
        		</#list>
       		</#if>
		FROM
			t_gangwei p
		LEFT JOIN t_organ o ON p.organ_id = o.id
		LEFT JOIN t_zhiwei p1 ON p.zhiwei_id = p1.id
		LEFT JOIN wec_user u ON u.gangwei_id = p.id and  u.status != '3' and u.user_status in ('10','20','30','60')
		LEFT JOIN t_gangwei_skill_ref psr ON p.id = psr.gangwei_id
		LEFT JOIN t_agent_gangwei_ref agr ON p.id = agr.gangwei_id
		LEFT JOIN t_gangwei ag ON agr.agent_gangwei_id = ag.id
		LEFT JOIN t_ext_t_gangwei te ON te.id = p.id 
		LEFT JOIN wec_user u2 on u2.id = p.update_uid and  u2.status != '3'
		LEFT JOIN t_zhiwei_level zlt ON p.zhiji_top = zlt.id
		LEFT JOIN t_zhiwei_level zll ON p.zhiji_lower = zll.id
		WHERE
			p.company_id = :companyId
		<#if organPaths??  && organPaths?length gt 0>
		AND o.organ_paths like concat(:organPaths,'%')
       	</#if>
		AND p.`status` = '00'
		<#if key??  && key?length gt 0>
		and p.gangwei_name like concat('%',:key,'%')
       	</#if>
       	<#if dataRange??  && dataRange?length gt 0>
		${dataRange}
       	</#if>
       	<#if functions??  && functions?size gt 0>
				and (
            	<#list functions as thisfunc>
            		<#if thisfunc??  && thisfunc?size gt 0>
	           		 	(
	           		 	<#list thisfunc as selffunc>
	           		 			${selffunc.sqlStr}  
	           		 			 	<#if selffunc.funcType??  && selffunc.funcType?length gt 0> 
	           		 			 		<#if selffunc.funcType = 0>
	           		 			 			<
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 1>
	           		 			 			=
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 2>
	           		 			 			>
	           		 			 		</#if> 
	           		 			 	<#else>
	           		 			 	 like
									</#if>  
	           		 			'${selffunc.funcValue}'
	           		 		<#if selffunc_has_next> and</#if>
	           		 	</#list>	           		 		           	       
           		 		)
           		 		<#if thisfunc_has_next> or </#if>
           		 	</#if>          		 	
        		</#list>
        		)
       		</#if>
		GROUP BY
			p.id
		ORDER BY o.level, o.sort,o.sort,o.update_date desc,p.gangwei_code
			]]>
    </sql>
    <sql id="getGangweiNameListByOrganId" isRead="true">
        <![CDATA[
		SELECT
			p.id,
			p.gangwei_name gangweiName,
			o.organ_name organName
		FROM
			t_gangwei p
		LEFT JOIN t_organ o ON p.organ_id = o.id
		WHERE
			p.company_id = :companyId
		AND p.organ_id = :organId
		AND p.`status` = '00'
		<#if key??  && key?length gt 0>
		and p.gangwei_name like concat('%',:key,'%')
       	</#if>
		ORDER BY gangwei_code
			]]>
    </sql>

    <sql id="getMaxGangweiCode">
        <![CDATA[
		SELECT
			MAX(
				CAST(gangwei_code AS SIGNED)
			) gangweiCode
		FROM
			t_gangwei
		WHERE
			company_id = :companyId
			]]>
    </sql>

    <sql id="getGangweiforUser" isRead="true">
        <![CDATA[
        SELECT
			g.id,
			g.zhiwei_id zhiweiId,
			organ_id organId,
			gangwei_name gangweiName,
			o.organ_name organName
		FROM
			t_gangwei g
		LEFT JOIN t_organ o ON g.organ_id = o.id
		WHERE
			g.company_id = :companyId
		AND g.`status` = '00'
		<#if key??  && key?length gt 0>
        AND   gangwei_name like concat('%',:key,'%')
      	</#if>
      	${dataRange}
			]]>
    </sql>
    <sql id="checkGangweiName">
        <![CDATA[
		SELECT 
		 COUNT(*)
		FROM t_gangwei
		WHERE organ_id = :organId
		AND gangwei_name = :gangweiName
		AND `status` IN ('00','20')
		<#if gangweiId??  && gangweiId?length gt 0>
           AND id != :gangweiId
      	</#if>
			]]>
    </sql>
    <sql id="getGangweiInfo" isRead="true">
        <![CDATA[
		SELECT
			g.id,
			g.gangwei_name gangweiName,
			g.organ_id organId,
			g.zhiwei_id zhiweiId,
			o.organ_name organName,
			g.pid,
			g.parent_name parentName,
			g.member,
			g.zhiji_lower zhijiLower,
			g.zhiji_top zhijiTop,
			zlt.`name` zhijiTopName,
			zll.`name` zhijiLowerName,
			g.zhideng_lower zhidengLower,
			g.zhideng_top zhidengTop,
			g.gangwei_desc gangweiDesc,
			g.gangwei_duty gangweiDuty
		FROM
			t_gangwei g
		LEFT JOIN t_organ o ON g.organ_id = o.id
		LEFT JOIN t_zhiwei_level zlt ON g.zhiji_top = zlt.id
		LEFT JOIN t_zhiwei_level zll ON g.zhiji_lower = zll.id
		WHERE
			g.id = :gangweiId
		GROUP BY
			g.id
			]]>
    </sql>
    <sql id="getGangweiInfoList" isRead="true">
        <![CDATA[
		SELECT
			g.id,
			g.gangwei_name gangweiName,
			g.company_id companyId,
			g.organ_id organId,
			g.zhiwei_id zhiweiId,
			g.pid,
			g.parent_name parentName,
			g.member,
			g.zhiji_lower zhijiLower,
			g.zhiji_top zhijiTop,
			g.zhideng_lower zhidengLower,
			g.zhideng_top zhidengTop,
			GROUP_CONCAT(gsr.skill_id) skillId,
			GROUP_CONCAT(gsr.skill_level_top_id) skillLevelTopId,
			GROUP_CONCAT(gsr.skill_level_Lower_id) skillLevelLowerId,
			GROUP_CONCAT(agr.agent_gangwei_id) agentGangweiId,
			GROUP_CONCAT(agr.agent_level_id) agentLevelId,
			g.gangwei_desc gangweiDesc
		FROM
			t_gangwei g
		LEFT JOIN t_agent_gangwei_ref agr ON g.id = agr.gangwei_id
		LEFT JOIN t_gangwei_skill_ref gsr ON g.id = gsr.gangwei_id
		WHERE
			g.id in (:gangweiIds)
		GROUP BY
			g.id
			]]>
    </sql>
    <sql id="updateSubsetGangwei">
        <![CDATA[
		UPDATE t_gangwei
		SET path = REPLACE(path, :path, :newPath)
		WHERE
			path LIKE CONCAT(:path, '%')
			]]>
    </sql>
    <sql id="removeSkillRef">
        <![CDATA[
		DELETE
		FROM
			t_gangwei_skill_ref
		WHERE
			gangwei_id = :gangweiId
			]]>
    </sql>
    <sql id="removeAgentRef">
        <![CDATA[
		DELETE
		FROM
			t_agent_gangwei_ref
		WHERE
			gangwei_id = :gangweiId
			]]>
    </sql>
    <sql id="getOrganGangweiMember" isRead="true">
        <![CDATA[
		SELECT
			SUM(member)
		FROM
			t_gangwei
		WHERE
			organ_id = :organId
		AND `status` = '00'
		AND id != :id
			]]>
    </sql>
    <sql id="stopGangweiSubjetPath">
        <![CDATA[
		UPDATE t_gangwei
		SET path = REPLACE (path, :path, '')
		WHERE
			path LIKE CONCAT(:path, '%')
			]]>
    </sql>
    <sql id="stopGangweiSubjetPid">
        <![CDATA[
		UPDATE t_gangwei
		SET pid = '-1',
		parent_name = ''
		WHERE
			pid = :gangweiId
			]]>
    </sql>
    <sql id="getCopyFatherGangweiId" isRead="true">
        <![CDATA[
		SELECT
			id
		FROM
			t_gangwei
		WHERE
			gangwei_name = :gangweiName
		AND (organ_id = :organId OR organ_id = :pid)
			]]>
    </sql>
    <sql id="getStopGangweiPage" isRead="true">
        <![CDATA[
		SELECT
			g.id,
			o.organ_name organName,
			g.gangwei_name gangweiName,
			g.stop_date stopDate
		FROM
			t_gangwei g
		LEFT JOIN t_organ o ON g.organ_id = o.id
		WHERE
			g.company_id = :companyId
		AND g.`status` = '20'
		<#if key??  && key?length gt 0>
		AND g.gangwei_name LIKE CONCAT('%', :key, '%')
		</#if>
		${dataRange}
			]]>
    </sql>
    <sql id="getStopGangweiOgranInfo" isRead="true">
        <![CDATA[
		SELECT
			g.id,
			g.organ_id organId,
			g.gangwei_name gangweiName,
			g.pid,
			g.parent_name parentName,
			g.member
		FROM
			t_gangwei g
		WHERE
			g.id IN (:gangweiIds)
			]]>
    </sql>
    <sql id="getGangweiIdsByOrgan" isRead="true">
        <![CDATA[
		SELECT
			id
		FROM
			t_gangwei
		WHERE
			organ_id IN (:organIds)
		AND pid = '-1'
		AND `status` = 0
			]]>
    </sql>
    <sql id="getGangweiTree" isRead="true">
        <![CDATA[
		SELECT
			g.id,
			g.member,
			g.gangwei_name gangweiName,
			g.pid,
			g.organ_id organId,
			o.organ_name organName,
			g.color,
			COUNT(DISTINCT u.id) userCount
		FROM
			t_gangwei g
		LEFT JOIN t_organ o ON g.organ_id = o.id
		LEFT JOIN wec_user u ON u.gangwei_id = g.id
		WHERE
			g.path LIKE CONCAT(:gangweiId, '%')
		AND g.`status` = '00'
		GROUP BY g.id
			]]>
    </sql>
    
     <sql id="getGangweiUserCount" isRead="true">
        <![CDATA[
		SELECT
			COUNT(u.id) userCount
		FROM
		wec_user u 
		WHERE
			u.gangwei_id = :gangweiId
		and u.status != 3
		and u.user_status in ('30','10','20','60')
			]]>
    </sql>
    <sql id="inGangweiExtInfo">
        <![CDATA[
		INSERT INTO t_ext_t_gangwei 
		(id
		, company_id
		<#if filedList??  && filedList?size gt 0>
            <#list filedList as filed>
            ,${filed}
        	</#list>
        </#if>
		)
		VALUES
		(:id
		, :companyId
		<#if valueList??  && valueList?size gt 0>
            <#list valueList as value>
            ,:value
        	</#list>
        </#if>
		)
			]]>
    </sql>
    <sql id="updateGangweiExtInfo">
        <![CDATA[
		UPDATE t_ext_t_gangwei
		SET
		id = :gangweiId
		<#if filedList??  && filedList?size gt 0>
            <#list filedList as filed>
            ,${filed.filed} = '${filed.value}'
        	</#list>
        </#if>
		WHERE
			id = :gangweiId
			]]>
    </sql>
    <sql id="updateGangweiParentName">
        <![CDATA[
		UPDATE t_gangwei
		SET
		parent_name = :name
		WHERE
			pid = :id
			]]>
    </sql>
    <sql id="getAgentGangweiList" isRead="true">
        <![CDATA[
		SELECT
			agr.agent_gangwei_id agentGangweiId,
			g.gangwei_name gangweiName,
			agr.agent_level_id agentLevelId,
			o.organ_name organName
		FROM
			t_agent_gangwei_ref agr
		LEFT JOIN t_gangwei g ON agr.agent_gangwei_id = g.id
		left join t_organ o on g.organ_id = o.id
		WHERE
			agr.gangwei_id = :gangweiId
			]]>
	</sql>
	<sql id="getAgentGangweiInfoList" isRead="true">
        <![CDATA[
		SELECT
			r.*
		FROM
			t_agent_gangwei_ref r
		LEFT JOIN t_gangwei g ON r.agent_gangwei_id = g.id
		WHERE
			r.gangwei_id = :gangweiId
		AND g.`status` = '0'
		ORDER BY
			r.agent_level_id
			]]>
    </sql>
    <sql id="getAgentGangweiInfoList" isRead="true">
        <![CDATA[
		SELECT
			r.*
		FROM
			t_agent_gangwei_ref r
		LEFT JOIN t_gangwei g ON r.agent_gangwei_id = g.id
		WHERE
			r.gangwei_id = :gangweiId
		AND g.`status` = '0'
		ORDER BY
			r.agent_level_id
			]]>
    </sql>
    <sql id="getGangweiSkillList" isRead="true">
        <![CDATA[
		SELECT
			ref.skill_id skillId,
			ref.skill_level_lower_id skillLeverLowerId,
			ref.skill_level_top_id skillLevelTopId,
			s.skill_name skillName,
			slt.skill_level_name skillLevelTopName,
			sll.skill_level_name skillLevelLowerName
		FROM
			t_gangwei_skill_ref ref
		LEFT JOIN t_skill s ON ref.skill_id = s.id
		LEFT JOIN t_skill_level slt ON slt.id = ref.skill_level_top_id
		LEFT JOIN t_skill_level sll ON sll.id = ref.skill_level_lower_id
		WHERE
			ref.gangwei_id = :gangweiId
			]]>
    </sql>
    <sql id="checkGangweiUser" isRead="true">
        <![CDATA[
		SELECT
			COUNT(*)
		FROM
			wec_user
		WHERE
			gangwei_id = :gangweiId
		AND `status` IN ('0', '2')
		AND user_status IN ('10','20','30','60')
			]]>
    </sql>
    <sql id="getAllGangwei" isRead="true">
        <![CDATA[
		SELECT * FROM t_gangwei WHERE `status` = '0' and company_id = :companyId
			]]>
    </sql>
    <sql id="updateUserZhiwei" >
        <![CDATA[
		UPDATE wec_user
		SET zhiwei_id = :zhiweiId
		WHERE
			gangwei_id = :gangweiId
			]]>
    </sql>
	<sql id="getZhijiListByGangweiId" isRead="true">
		<![CDATA[
			SELECT
				z.id, 
				z.sort,
				z.name
			FROM
				t_zhiwei_level z
			WHERE
				z.company_id = :companyId
			AND z.status = 0
			AND z.type = '1'
			<#if zhijiTop??  && zhijiTop?length gt 0>
				AND z.sort <= (
				SELECT
					z1.sort
				FROM
					t_zhiwei_level z1
				WHERE
					z1.id = :zhijiTop
			)
			</#if>
			<#if zhijiLower??  && zhijiLower?length gt 0>
			AND z.sort >= (
				SELECT
					z2.sort
				FROM
					t_zhiwei_level z2
				WHERE
					z2.id = :zhijiLower
			)
			</#if>
			order by z.sort desc
		]]>
	</sql>
	
	<sql id="getAllGangweiListWithOrganPathName" isRead="true">
        <![CDATA[
		SELECT
			p.id,
			p.gangwei_name gangweiName,
			o.id organId,
			o.organ_name organName
		FROM
			t_gangwei p
		LEFT JOIN t_organ o ON p.organ_id = o.id
		WHERE
			p.company_id = :companyId
			AND p.`status` = '00'
		<#if key?? && key?length gt 0>
			AND p.gangwei_name like concat('%',:key,'%')
      	</#if>
		<#if path?? && path?length gt 0>
			AND o.organ_paths like concat(:path,'%')
       	</#if>
     	<#if dataRange?? && dataRange?length gt 0>
			${dataRange}
     	 </#if>
		GROUP BY p.id
		ORDER BY p.gangwei_code
		]]>
    </sql>
    <sql id="getGangweiMemberInfo" isRead="true">
        <![CDATA[
		SELECT
			gm.id,
			gm.gangwei_id gangweiId,
			gm.add_member addMember,
			gm.reason,
			g.gangwei_name gangweiName,
			g.member,
			gm.process_id processId
		FROM
			t_gangwei_member gm
		LEFT JOIN t_gangwei g ON gm.gangwei_id = g.id
		WHERE
			gm.id = :id
			]]>
    </sql>

    <!--查询组织下所有岗位与组织对应关系-->
    <sql id="queryOrganAndGangwei" isRead="true">
        <![CDATA[
        SELECT
        t.id organId,
        GROUP_CONCAT(tg.id) gangweiIds
        FROM
        t_organ t
        INNER JOIN t_gangwei tg ON t.id = tg.organ_id
        WHERE
        t.company_id =:companyId
        AND t.organ_paths like concat(:organPaths,'%')
        GROUP BY
        t.id
        ]]>
    </sql>

	<sql id="listQueryByGangweiIds" isRead="true">
        <![CDATA[
       		select * from t_gangwei t where t.id in(:ids)
        ]]>
    </sql>
	<sql id="getGangweiInfoByName" isRead="true">
        <![CDATA[
       		SELECT
				*
			FROM
				t_gangwei
			WHERE
				company_id = :companyId
			AND `status` = '0'
			AND gangwei_name = :gangweiName
			AND organ_id = :organId
        ]]>
    </sql>
</sqlMap>
