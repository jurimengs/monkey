<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="GoodsUse">

    <!--查询数量-->
    <sql id="queryCount" isRead="true">
        <![CDATA[
        SELECT
        count(1) totalCount,
        ifnull(sum(if(t.guihuan_status=1,1,0)),0) notNeedGuihuanCount,
        ifnull(sum(if(t.guihuan_status=0,1,0)),0) notGuihuanCount,
        ifnull(sum(if(t.guihuan_status=2,1,0)),0) alreadyGuihuanCount
        FROM
        t_goods_lingyong t
        LEFT JOIN t_company_goods tcg ON t.goods_id = tcg.id
        left join wec_user w on t.user_id=w.id
        left join t_organ tor on tor.id=w.organ_id
        where t.company_id=:companyId
        and t.`status`=0
         <#if keyword?? && keyword?length gt 0>
				AND (w.user_name like concat('%', :keyword, '%')
                        OR tor.organ_name like concat('%', :keyword, '%')
                        OR w.emp_no like concat('%', :keyword, '%')
                        OR tcg.goods_name like concat('%', :keyword, '%')
                        )
         </#if>
            <#if organPaths?? && organPaths?length gt 0>
                    AND tor.organ_paths like CONCAT (:organPaths,'%')
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>
        <#if functions??  && functions?size gt 0>
                    and (
            <#list functions as thisfunc>
                <#if thisfunc??  && thisfunc?size gt 0>
                            (
                    <#list thisfunc as selffunc>
                        ${selffunc.sqlStr}
                        <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                            <#if selffunc.funcType = 0>
                                                <
                            </#if>
                            <#if selffunc.funcType = 1>
                                                =
                            </#if>
                            <#if selffunc.funcType = 2>
                                                >
                            </#if>
                        <#else>
                                         like
                        </#if>
                                    '${selffunc.funcValue}'
                        <#if selffunc_has_next> and</#if>
                    </#list>
                            )
                    <#if thisfunc_has_next> or </#if>
                </#if>
            </#list>
            )
        </#if>
		]]>
    </sql>

    <!--查询详情-->
    <sql id="queryById" isRead="true">
        <![CDATA[
            SELECT
                t.id,
                w.emp_no empNo,
                w.user_name userName,
                tor.organ_name organName,
                tg.gangwei_name gangweiName,
                tc.goods_name goodsName,
                tc.goods_type goodsType,
                tgg.kouchu,
                tgg.guihuan_count guihuanCount,
                tgg.guihuan_type guihuanType,
                t.lingyong_count lingyongCount,
		        DATE_FORMAT(t.lingyong_date, '%Y-%m-%d')  lingyongDate,
		        DATE_FORMAT(t.guihuan_date, '%Y-%m-%d')  guihuanDate,
                t.guihuan_status guihuanStatus,
                t.remark,
                t.user_id userId,
                tc.price,
                tc.yajin,
                tgg.guihuan_type guihuanType,
                tgg.id guihuanId
            FROM
                t_goods_lingyong t
            LEFT JOIN t_company_goods tc ON tc.id = t.goods_id
            LEFT JOIN t_goods_guihuan tgg ON tgg.lingyong_id = t.id
            LEFT JOIN wec_user w ON t.user_id = w.id
            LEFT JOIN t_organ tor ON tor.id = w.organ_id
            LEFT JOIN t_gangwei tg ON tg.id = w.gangwei_id
            WHERE
                t.id=:id
		]]>
    </sql>


    <!--分页查询-->
    <sql id="pageQuery" isRead="true">
        <![CDATA[
           SELECT
                t.id,
                w.emp_no empNo,
                w.user_name userName,
                tor.organ_name organName,
                tor.id organId,
                tg.gangwei_name gangweiName,
                tc.goods_name goodsName,
                t.lingyong_count lingyongCount,
                DATE_FORMAT(t.lingyong_date, '%Y-%m-%d')  lingyongDate,
                 DATE_FORMAT(t.guihuan_date, '%Y-%m-%d')  guihuanDate,
                t.guihuan_status guihuanStatus,
                ww.user_name updateUserName,
                t.update_date updateDate,
                t.remark
                 <#if selfFields??  && selfFields?size gt 0>
                        ,
                     <#list selfFields as selfField>
                            ext.${selfField}
                         <#if selfField_has_next>,</#if>
                     </#list>
                 </#if>
            FROM
                t_goods_lingyong t
            LEFT JOIN t_company_goods tc ON tc.id = t.goods_id
            LEFT JOIN wec_user w ON t.user_id = w.id
            LEFT JOIN t_organ tor ON tor.id = w.organ_id
            LEFT JOIN t_gangwei tg ON tg.id = w.gangwei_id
            left join wec_user ww on ww.id=t.update_uid
            WHERE
                t.company_id =:companyId
            <#if keyword?? && keyword?length gt 0>
				AND (w.user_name like concat('%', :keyword, '%')
                        OR tor.organ_name like concat('%', :keyword, '%')
                        OR w.emp_no like concat('%', :keyword, '%')
                        OR tc.goods_name like concat('%', :keyword, '%')
                        )
            </#if>
            <#if organPaths?? && organPaths?length gt 0>
                    AND tor.organ_paths like CONCAT (:organPaths,'%')
            </#if>
            <#if lingyongDate?? && lingyongDate?length gt 0>
                    AND t.lingyong_date = :lingyongDate
            </#if>
            <#if guihuanDate?? && guihuanDate?length gt 0>
                    AND t.guihuan_date = :guihuanDate
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>
            <#if tabId?? && tabId?length gt 0>
                <#if tabId == 'notGuihuanCount'>
                        and t.guihuan_status=0
                </#if>
                <#if tabId == 'alreadyGuihuanCount'>
                        and t.guihuan_status=2
                </#if>
                <#if tabId == 'notNeedGuihuanCount'>
                        and t.guihuan_status=1
                </#if>
            </#if>
            <#if functions??  && functions?size gt 0>
                    and (
                <#list functions as thisfunc>
                    <#if thisfunc??  && thisfunc?size gt 0>
                            (
                        <#list thisfunc as selffunc>
                            ${selffunc.sqlStr}
                            <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                                <#if selffunc.funcType = 0>
                                                <
                                </#if>
                                <#if selffunc.funcType = 1>
                                                =
                                </#if>
                                <#if selffunc.funcType = 2>
                                                >
                                </#if>
                            <#else>
                                         like
                            </#if>
                                    '${selffunc.funcValue}'
                            <#if selffunc_has_next> and</#if>
                        </#list>
                            )
                        <#if thisfunc_has_next> or </#if>
                    </#if>
                </#list>
                )
            </#if>
             order by t.create_date desc
		]]>
    </sql>

    <!--查询可用的物品-->
    <sql id="queryGoodsByUser" isRead="true">
        <![CDATA[
            SELECT
            tc.id,
            tc.goods_name goodsName,
            tc.goods_no goodsNo,
            tc.goods_type goodsType,
            tc.unused_count unusedCount,
            tc.need_return needReturn
            FROM
            t_company_goods_range t
            LEFT JOIN t_company_goods tc ON t.goods_id = tc.id
            WHERE
            t.organ_id =:organId
            and t.company_id=:companyId
            and tc.id is not null
            and tc.status=0
            <#if keyword??  && keyword?length gt 0>
                        AND tc.goods_name LIKE concat('%' ,:keyword, '%')
            </#if>
            order by tc.goods_no
		]]>
    </sql>

    <!--查询用户的领用物品记录-->
    <sql id="queryUserLingyongGoods" isRead="true">
        <![CDATA[
        SELECT
        tgl.id,
        tcg.goods_name goodsName,
        tgl.lingyong_count lingyongCount,
        DATE_FORMAT(
        tgl.lingyong_date,
        '%Y-%m-%d'
        ) lingyongDate,
        DATE_FORMAT(
        tgl.guihuan_date,
        '%Y-%m-%d'
        ) guihuanDate,
        tgl.guihuan_status guihuanStatus,
        tgl.remark
        FROM
        t_goods_lingyong tgl
        LEFT JOIN t_company_goods tcg ON tgl.goods_id = tcg.id
        where tgl.user_id=:userId
        order by tgl.lingyong_date desc
        ]]>
    </sql>


    <!--查询物品的领用和归还数量-->
    <sql id="queryGoodsLingyongAndGuihuanCount" isRead="true">
        <![CDATA[
        SELECT
        ifnull(sum(tgl.lingyong_count), 0) lingyongCount,
        ifnull(sum(if(tgg.id=null,0,tgl.lingyong_count)),0) hasGuihuanLingyongCount,
        sum(
        ifnull(tgg.guihuan_count, 0)
        ) guihuanCount
        FROM
        t_goods_lingyong tgl
        LEFT JOIN t_goods_guihuan tgg ON tgl.id = tgg.lingyong_id
        WHERE
        tgl.goods_id =:goodsId
        ]]>
    </sql>


    <!--查询物品归还-->
    <sql id="queryReturn" isRead="true">
        <![CDATA[
        SELECT
        t.*
        FROM
        t_goods_guihuan t
        WHERE
        t.lingyong_id =:lingyongId
        ]]>
    </sql>





</sqlMap>
