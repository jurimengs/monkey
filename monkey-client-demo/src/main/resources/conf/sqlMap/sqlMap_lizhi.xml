<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="Lizhi">
    <sql id="findLizhiList" isRead="true">
        <![CDATA[
            select 
                lz.id as id, lz.company_id as companyId, lz.user_id as userId, date_format(lz.left_date, '%Y-%m-%d') as leftDate, 
                lz.reason as reason, date_format(lz.create_date, '%Y-%m-%d') as createDate, operator.user_name as createUserName, lz.create_uid as createUid, lz.comment, 
                lz.update_uid as updateUid, date_format(lz.update_date, '%Y-%m-%d') as updateDate, 
                date_format(lz.last_chuqin_date, '%Y-%m-%d') as lastChuqinDate, 
                lz.status as status, lz.process_id as processId, 
                u.emp_no as empNo, u.user_name as userName, u.organ_id as organId, g.gangwei_name as gangweiName, lz.black, 
                date_format(u.entry_date, '%Y-%m-%d') as entryDate
                <#if selfFields??  && selfFields?size gt 0>
                    ,
                    <#list selfFields as selfField>
                        ${selfField.tableName}.${selfField.fieldName} ${selfField.fieldDesc}
                        <#if selfField_has_next>,</#if>
                    </#list>
                </#if>
            
                FROM `t_lizhi` lz
                left join wec_user u on u.id = lz.user_id 
                left join wec_user operator on operator.id = lz.update_uid 
                left join t_organ o on o.id = u.organ_id 
                left join t_gangwei g on g.id = u.gangwei_id 
                left join t_ext_t_lizhi lzext on lzext.id = lz.id 
                where lz.company_id = :companyId
                ${dataRange}
        
            <#if status = 0>
                AND lz.status in (0, 10)
            <#elseif status = 1>
                AND lz.status in (60, 70)
            <#elseif status = 3>
                AND lz.status in (20,30)
            <#elseif status?? && status?length gt 0>
                AND lz.status = :status
            <#else>
                AND lz.status <> 5
            </#if>
            <#if userId?? && userId?length gt 0>
                AND u.id = :userId
            </#if>
        
            <#if organIds?? && organIds?size gt 0>
                and o.id in (:organIds) 
            </#if>
            <#if keyWord?? && keyWord?length gt 0>
                AND (u.user_name like concat('%', :keyWord, '%')
                    OR u.emp_no = :keyWord
                    OR o.organ_name like concat('%', :keyWord, '%')
                    OR g.gangwei_name like concat('%', :keyWord, '%')
                )
            </#if>

            <#if selfFunctions??  && selfFunctions?size gt 0>
				AND (
				<#list selfFunctions as thisfunc>
					<#if thisfunc??  && thisfunc?size gt 0>
						(
						<#list thisfunc as selffunc>
								${selffunc.tableName}.${selffunc.fieldName}
									<#if selffunc.fieldType??  && selffunc.fieldType?length gt 0>
										<#if selffunc.fieldType = 0>
											<
										</#if>
										<#if selffunc.fieldType = 1>
											=
										</#if>
										<#if selffunc.fieldType = 2>
											>
										</#if>
									<#else>
									 like
									</#if>
								${selffunc.funcValue}
							<#if selffunc_has_next> and</#if>
						</#list>
						)
						<#if thisfunc_has_next> or </#if>
					</#if>
				</#list>
				)
			</#if>
            order by lz.create_date desc
        ]]>
    </sql>
    <sql id="findByUserId" isRead="true">
        <![CDATA[
            select * FROM `t_lizhi` where user_id = :userId and company_id = :companyId and status in (0, 10,20, 30, 60)
        ]]>
    </sql>
    <sql id="findLastByUserId" isRead="true">
        <![CDATA[
            select * FROM `t_lizhi` where user_id = :userId and company_id = :companyId and status in (0, 60, 70) and is_last = 0
        ]]>
    </sql>
    <sql id="findListByLeftDate" isRead="true">
        <!--  如果有审批人逾期未审的，视作已审批处理？
        -->
        <![CDATA[
            select * FROM `t_lizhi` where DATE_FORMAT(left_date, '%Y-%m-%d') = :leftDate and status in (60,70)
        ]]>
    </sql>
    
    <sql id="findCountsGroupByStatus" isRead="true">
        <![CDATA[
            select lz.status, count(lz.status) as counts from t_lizhi lz 
                left join wec_user u on u.id = lz.user_id 
                left join t_organ o on o.id = u.organ_id 
                left join t_gangwei g on g.id = u.gangwei_id 
            where lz.company_id = :companyId
            and lz.status in (0, 10, 20, 30, 60, 70)
            <#if organIds?? && organIds?size gt 0>
                and o.id in (:organIds) 
            </#if>
            
            ${dataRange}
            
            <#if keyWord?? && keyWord?length gt 0>
                AND (u.user_name like concat('%', :keyWord, '%')
                    OR u.emp_no = :keyWord
                    OR o.organ_name like concat('%', :keyWord, '%')
                    OR g.gangwei_name like concat('%', :keyWord, '%')
                )
            </#if>

            <#if selfFunctions??  && selfFunctions?size gt 0>
                AND (
                <#list selfFunctions as thisfunc>
                    <#if thisfunc??  && thisfunc?size gt 0>
                        (
                        <#list thisfunc as selffunc>
                                ${selffunc.tableName}.${selffunc.fieldName}
                                    <#if selffunc.fieldType??  && selffunc.fieldType?length gt 0>
                                        <#if selffunc.fieldType = 0>
                                            <
                                        </#if>
                                        <#if selffunc.fieldType = 1>
                                            =
                                        </#if>
                                        <#if selffunc.fieldType = 2>
                                            >
                                        </#if>
                                    <#else>
                                     like
                                    </#if>
                                ${selffunc.funcValue}
                            <#if selffunc_has_next> and</#if>
                        </#list>
                        )
                        <#if thisfunc_has_next> or </#if>
                    </#if>
                </#list>
                )
            </#if>
            
            
            group by lz.status
        ]]>
    </sql>
    
    <!--  这个count 恐怕还得连数据权限一起查  -->
    <sql id="countTotal" isRead="true">
        <![CDATA[
            select count(1) as count from t_lizhi lz 
                left join wec_user u on lz.user_id = u.id
                left join t_organ o on o.id = u.organ_id 
                left join t_gangwei g on g.id = u.gangwei_id 
            where lz.company_id = :companyId and lz.status <> 1
            
            ${dataRange}
            <#if organIds?? && organIds?size gt 0>
                and o.id in (:organIds) 
            </#if>
            AND lz.status <> 5
            
        ]]>
    </sql>
    
    <sql id="delete">
        <![CDATA[
            update t_lizhi set status = :status, update_uid= :operatorId, update_date = SYSDATE()
            where id = :id and company_id = :companyId
        ]]>
    </sql>
    
    <sql id="countByUserId" isRead="true">
        <![CDATA[
            select count(1) from t_lizhi where company_id = :companyId and user_id = :userId
        ]]>
    </sql>

    <sql id="findLizhiById" isRead="true">
        <![CDATA[
            SELECT
                l.id AS id,
                l.company_id AS companyId,
                l.user_id AS userId,
                l.left_date AS leftDate,
                l.last_chuqin_date as lastChuqinDate,
                l.reason,
                l.create_date AS createDate,
                l.create_uid AS createUid,
                l.`comment`,
                l.black,
                l.`status`,
                l.process_id as processId, 
                u.user_name as userName,
                u.emp_no as empNo,
                u.organ_id as organId,
                o.organ_name as organName,
                u.gangwei_id as gangweiId,
                g.gangwei_name as gangweiName,
                u.entry_date as entryDate
            FROM
                t_lizhi l
            LEFT JOIN wec_user u ON l.user_id = u.id
            LEFT JOIN t_organ o ON u.organ_id = o.id
            LEFT JOIN t_gangwei g ON u.gangwei_id = g.id
            where l.id = :id and l.company_id = :companyId
        ]]>
    </sql>
    
    <sql id="findLizhiByIdSelt" isRead="true">
        <![CDATA[
            SELECT
                t_lizhi.id AS id,
                t_lizhi.company_id AS companyId,
                t_lizhi.user_id AS userId,
                t_lizhi.left_date AS leftDate,
                t_lizhi.last_chuqin_date as lastChuqinDate,
                t_lizhi.reason,
                t_lizhi.create_date AS createDate,
                t_lizhi.create_uid AS createUid,
                t_lizhi.`comment`,
                t_lizhi.black,
                t_lizhi.`status`,
                t_lizhi.process_id as processId, 
                wec_user.user_name as userName,
                wec_user.emp_no as empNo,
                wec_user.organ_id as organId,
                t_organ.organ_name as organName,
                wec_user.gangwei_id as gangweiId,
                t_gangwei.gangwei_name as gangweiName,
                wec_user.entry_date as entryDate, 
                <#if fields?? && fields?size gt 0>
					<#list fields as field>
							${field} ,
					</#list>
				</#if> 
				wec_user.entry_date as entryDate
            FROM
                t_lizhi 
            LEFT JOIN t_ext_t_lizhi on t_ext_t_lizhi.id = t_lizhi.id
            LEFT JOIN wec_user ON t_lizhi.user_id = wec_user.id
            LEFT JOIN t_organ ON wec_user.organ_id = t_organ.id
            LEFT JOIN t_gangwei ON wec_user.gangwei_id = t_gangwei.id
            where t_lizhi.id = :id and t_lizhi.company_id = :companyId
        ]]>
    </sql>
    
    <sql id="findEntityById" isRead="true">
        <![CDATA[
            SELECT *
            FROM t_lizhi
            where id = :id
        ]]>
    </sql>
    
    <sql id="updateApproveCustomFields" >
        <![CDATA[
        UPDATE ${filedValues.tableName}
        SET ${filedValues.filed} = '${filedValues.value}'
        WHERE
            id = :id
        ]]>
    </sql>
    
    <sql id="updateIsLastToNo" >
        <![CDATA[
        UPDATE t_lizhi set is_last = 1 where is_last = 0 and user_id = :userId and company_id = :companyId
        ]]>
    </sql>
    <sql id="getLastLizhiInTime" isRead="true">
        <![CDATA[
            SELECT
                left_date
            FROM
                t_lizhi
            WHERE
                ( left_date BETWEEN :startDate AND :endDate )
                AND user_id = :userId
                AND company_id = :companyId
                AND `status` in (60,70)
                order by left_date desc limit 1
        ]]>
    </sql>
    <sql id="getLastLizhiRecord" isRead="true">
        <![CDATA[
            SELECT
                left_date
            FROM
                t_lizhi
            WHERE
                user_id = :userId
                AND company_id = :companyId
                AND `status` in (60,70)
                order by left_date desc limit 1
        ]]>
    </sql>

    <sql id="checkLizhiByDate" isRead="true">
        <![CDATA[
            SELECT
                count(1)
            from
                t_lizhi
            WHERE
                DATE_FORMAT( left_date, '%Y-%m-%d' ) = :date
                AND user_id = :userId
                AND `status` in (60,70)
                limit 1
        ]]>
    </sql>
    
    <sql id="addLizhiSelf">
        <![CDATA[
            INSERT INTO t_ext_t_lizhi(id,company_id,
            	<#list selfList as selfField>
            		${selfField.field}
            	<#if selfField_has_next> , </#if>
            	</#list>
            )
                VALUES (
                :id,:companyId,
                <#list selfList as selfField>
            		'${selfField.value}'
            	<#if selfField_has_next> , </#if>
            	</#list>
                )                        
        ]]>
    </sql>
    <sql id="updateLizhiSelf">
        <![CDATA[
             UPDATE t_ext_t_lizhi SET 
            <#list selfList as selfField>
            	${selfField.field} = '${selfField.value}'
            	<#if selfField_has_next> , </#if>
            </#list>         
			WHERE id = :id and  company_id = :companyId                
        ]]>
    </sql>
    <sql id="queryExtById">
		<![CDATA[
           select count(1)  from t_ext_t_lizhi where id=:id
        ]]>
	</sql>
</sqlMap>