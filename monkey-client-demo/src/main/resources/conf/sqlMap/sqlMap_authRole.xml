<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="AuthRole">

    <sql id="findAll" isRead="true">
        <![CDATA[
            SELECT * from wec_auth_role
        ]]>
    </sql>

    <sql id="findEntityByUniqueKey" isRead="true">
        <![CDATA[
            SELECT id, obj_id, company_id, role_id, obj_type, create_date, create_uid, update_date, update_uid 
            FROM `wec_auth_role` where obj_id=:objId 
            and obj_type = :objType and role_id = :roleId and company_id = :companyId
        ]]>
    </sql>

    <sql id="findEmpListWithAuth" isRead="true">
        <![CDATA[
            SELECT u.id, ar.id as authRoleId, u.pnid, u.emp_no as empNo, u.user_name as userName, og.id as organId, g.gangwei_name as gangweiName, 
                ar.view_range as viewRange, ar.view_range_ext as viewRangeExt, ar.view_emp_type as viewEmpType, ar.create_date as createDate,
                ar.create_uid as createUid
            FROM wec_user u
            left join wec_auth_role ar on ar.obj_id = u.id 
            left join t_gangwei g on u.gangwei_id = g.id
            left join t_organ og on g.organ_id = og.id 
            
            where ar.obj_type = 0 and u.status=0 and g.status = 0 and og.status = 0 and u.user_status!=40
            and u.company_id = :companyId
            
            <#if roleId?? && roleId?length gt 0>
                AND ar.role_id = :roleId
            </#if>
            <#if userName?? && userName?length gt 0>
                AND u.user_name like concat ('%', :userName, '%')
            </#if>
            <#if deptName?? && deptName?length gt 0>
                AND og.organ_name like concat ('%', :deptName, '%')
            </#if>
            <#if organIds?? && organIds?size gt 0>
                AND og.id in (:organIds)
            </#if>
            <#if gangweiName?? && gangweiName?length gt 0>
                AND g.gangwei_name like concat ('%', :gangweiName, '%')
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>
        ]]>
    </sql>

    <sql id="findGangweiListWithAuth" isRead="true">
        <![CDATA[
            SELECT g.id, ar.id as authRoleId, og.id as organId, g.gangwei_name as gangweiName, 
                ar.view_range as viewRange, ar.view_range_ext as viewRangeExt, ar.view_emp_type as viewEmpType, ar.create_date as createDate,
                ar.create_uid as createUid
            FROM t_gangwei g
            left join wec_auth_role ar on ar.obj_id = g.id
            left join t_organ og on g.organ_id = og.id 
             
            where ar.obj_type = 1 and g.status = 0 and og.status = 0
            and ar.company_id = :companyId 
            <#if roleId?? && roleId?length gt 0>
                AND ar.role_id =:roleId
            </#if>
            <#if deptName?? && deptName?length gt 0>
                AND og.organ_name like concat ('%', :deptName, '%')
            </#if>
            <#if organId?? && organId?length gt 0>
                AND og.id = :organId
            </#if>
            <#if companyId?? && companyId?length gt 0>
                AND g.company_id = :companyId
            </#if>
        ]]>
    </sql>

    <sql id="findZhiweiListWithAuth" isRead="true">
        <![CDATA[
        SELECT z.id, ar.id as authRoleId, z.zhiwei_name as zhiweiName, 
                ar.view_range as viewRange, ar.view_range_ext as viewRangeExt, ar.view_emp_type as viewEmpType, ar.create_date as createDate,
                ar.create_uid as createUid
                FROM t_zhiwei z
            left join wec_auth_role ar on ar.obj_id = z.id
             
            where ar.obj_type = 2 and z.`status` = 0 
            and ar.company_id = :companyId
            <#if roleId?? && roleId?length gt 0>
                AND ar.role_id =:roleId
            </#if>
            <#if zhiweiName?? && zhiweiName?length gt 0>
                AND z.zhiwei_name like concat ('%', :zhiweiName, '%')
            </#if>
            <#if companyId?? && companyId?length gt 0>
                AND z.company_id = :companyId
            </#if>
        ]]>
    </sql>
    
    <sql id="findEmpListUnAuth" isRead="true">
        <![CDATA[
            SELECT u.id, u.user_name as userName, og.id as organId, g.gangwei_name as gangweiName
            FROM wec_user u
            left join t_gangwei g on u.gangwei_id = g.id
            left join t_organ og on g.organ_id = og.id 
             
            where u.status=0 and g.status = 0 and og.status = 0 and u.user_status != 40
            AND u.company_id = :companyId
            AND NOT EXISTS (select ar.id from wec_auth_role ar where ar.obj_id = u.id and ar.role_id = :roleId)

            <#if organIds?? && organIds?size gt 0>
                and og.id in (:organIds) 
            </#if>
            <#if userName?? && userName?length gt 0>
                AND u.user_name like concat ('%', :userName, '%')
            </#if>
            <#if deptName?? && deptName?length gt 0>
                AND og.organ_name like concat ('%', :deptName, '%')
            </#if>
        ]]>
    </sql>
    
    <sql id="findGangweiListUnAuth" isRead="true">
        <![CDATA[
            SELECT g.id, og.id as organId, g.gangwei_name as gangweiName 
            FROM t_gangwei g
            left join t_organ og on g.organ_id = og.id
            where g.status = 0 and og.status = 0 
            AND g.company_id = :companyId
            AND NOT EXISTS (select ar.id from wec_auth_role ar where ar.obj_id = g.id and ar.role_id = :roleId)

            <#if organIds?? && organIds?size gt 0>
                and og.id in (:organIds) 
            </#if>
            <#if deptName?? && deptName?length gt 0>
                AND og.organ_name like concat ('%', :deptName, '%')
            </#if>
            <#if gangweiName?? && gangweiName?length gt 0>
                AND g.gangwei_name like concat ('%', :gangweiName, '%')
            </#if>
        ]]>
    </sql>

    <sql id="findZhiweiListUnAuth" isRead="true">
        <![CDATA[
        SELECT z.id, z.zhiwei_name as zhiweiName, z.type as zhiweiType 
                FROM t_zhiwei z
            where z.company_id = :companyId and z.`status` = 0 
            AND NOT EXISTS (select ar.id from wec_auth_role ar where ar.obj_id = z.id and ar.role_id = :roleId)
            
            <#if zhiweiName?? && zhiweiName?length gt 0>
                AND z.zhiwei_name like concat ('%', :zhiweiName, '%')
            </#if>
            <#if zhiweiIds?? && zhiweiIds?size gt 0>
                AND z.id in (:zhiweiIds)
            </#if>
        ]]>
    </sql>
    
    <sql id="deleteByIds">
        <![CDATA[
        delete from wec_auth_role 
            where company_id = :companyId
            <#if ids?? && ids?size gt 0>
                AND id in  (:ids)
            </#if>
            
        ]]>
    </sql>
    
    <sql id="deleByRoleId">
        <![CDATA[
            delete from wec_auth_role 
            where company_id = :companyId and role_id = :roleId
        ]]>
    </sql>

    <sql id="findEntitysByRoleId" isRead="true">
        <![CDATA[
            select id, obj_id, company_id, role_id, obj_type, create_date, create_uid, update_date, update_uid 
            from wec_auth_role
            where company_id=:companyId AND role_id = :roleId
        ]]>
    </sql>

    <sql id="authCancel">
        <![CDATA[
            delete from wec_auth_role where role_id = :roleId and company_id = :companyId
                and obj_id in (:objIds)
        ]]>
    </sql>

    <!-- 注意，进入这个sql 之前，必需保证 obj_id 不为空集合-->
    <sql id="findAuthRoleListByUserAndViewRangeNotNull" isRead="true">
        <![CDATA[
            SELECT *
            FROM `wec_auth_role`
            where obj_id in (:objIds)
        ]]>
    </sql>
    
    <sql id="findEntitysByIds" isRead="true">
        <![CDATA[
            SELECT *
            FROM `wec_auth_role`
            where id in (:ids)
        ]]>
    </sql>

    <sql id="hasRole" isRead="true">
        <![CDATA[
            select war.id from wec_auth_role war
                left join wec_user wu on war.obj_id = wu.id or war.obj_id = wu.gangwei_id or war.obj_id = wu.zhiwei_id
	        where war.role_id = :roleId and wu.id = :userId;
        ]]>
    </sql>
</sqlMap>
