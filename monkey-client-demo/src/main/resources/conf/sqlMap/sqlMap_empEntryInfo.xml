<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="EmpEntryInfo">

	<sql id="getExpiredInfoPage" isRead="true">
		<![CDATA[
			SELECT 
				u.id,
				u.emp_no empNo,
				u.user_name userName,
				u.organ_id organId,
				u.gangwei_id gangweiId,
				g.gangwei_name gangweiName,
				o.organ_name organName,
				g.zhiwei_id zhiweiId,
				z.zhiwei_name zhiweiName,
				info.id infoId,
				info.name infoName,
				info.data_status dataStatus,
				info.size,
				info.data_type,
				info.data_addr dataAddr,
				info.data_over_time dataOverTime,
				if(info.data_over_time IS NOT NULL,TO_DAYS(info.data_over_time) - TO_DAYS(NOW()) ,-6666) expiredDays,
				CASE info.data_type
						WHEN 1 THEN <#if sortFlag?? && sortFlag==1>0<#else>1</#if>
						WHEN 2 THEN <#if sortFlag?? && sortFlag==2>0<#else>2</#if>
						WHEN 3 THEN	<#if sortFlag?? && sortFlag==3>0<#else>3</#if>
						WHEN 4 THEN	<#if sortFlag?? && sortFlag==4>0<#else>4</#if>
						WHEN 5 THEN	<#if sortFlag?? && sortFlag==5>0<#else>5</#if>
						ELSE 9999 
				END sort
			FROM wec_user u
			LEFT JOIN t_organ o ON o.id = u.organ_id
			LEFT JOIN t_gangwei g ON u.gangwei_id = g.id
			LEFT JOIN t_zhiwei z ON g.zhiwei_id = z.id
			LEFT JOIN t_emp_entry_info info ON u.id = info.user_id
			WHERE
				u.company_id = :companyId
				AND u.status NOT IN ('3','5') AND u.user_status NOT IN ('40','50')
				AND info.id IS NOT NULL
			<#if dataType??  && dataType?length gt 0>
                AND info.data_type = :dataType
            </#if>   
			<#if dataStatus?? && dataStatus == 0>
				AND info.data_over_time IS NOT NULL 
				AND (TO_DAYS(info.data_over_time) - TO_DAYS(NOW())) < 0
			<#elseif dataStatus?? && dataStatus == 1>
				AND info.data_over_time IS NOT NULL 
				AND (TO_DAYS(info.data_over_time) - TO_DAYS(NOW())) >= 0
				AND (TO_DAYS(info.data_over_time) - TO_DAYS(NOW())) <= 30
			<#else>
				AND IF(info.data_over_time IS NOT NULL,TO_DAYS(info.data_over_time) - TO_DAYS(NOW()),-36500) <= 30
			</#if>
			<#if key??  && key?length gt 0>
	           	AND (
				o.organ_name LIKE CONCAT('%', :key, '%')
				OR g.gangwei_name LIKE CONCAT('%', :key, '%')
				OR u.user_name LIKE CONCAT('%', :key, '%')
				)
		    </#if>
			<#if dataRange??  && dataRange?length gt 0>
	           	${dataRange}
	       	</#if>
			ORDER BY sort ASC, expiredDays ASC, u.emp_no ASC
		]]>
	</sql>
	
	<sql id="getEmpEntryInfoByUserId" isRead="true">
		<![CDATA[
			SELECT 
				u.id userId,
				u.emp_no empNo,
				u.user_name userName,
				info.id infoId,
				info.name infoName,
				info.data_status dataStatus,
				info.size,
				info.data_type,
				info.data_addr dataAddr,
				info.data_over_time dataOverTime,
				if(info.data_over_time IS NOT NULL,TO_DAYS(info.data_over_time) - TO_DAYS(NOW()) ,-6666) expiredDays
			FROM wec_user u
			LEFT JOIN t_emp_entry_info info ON u.id = info.user_id
			WHERE
				u.company_id = :companyId
				AND u.status NOT IN ('3','5') AND u.user_status NOT IN ('40','50')
				AND u.id = :userId
			ORDER BY info.data_type ASC
		]]>
	</sql>
</sqlMap>
