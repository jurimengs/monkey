<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="DiaoDong">
    <sql id="findDiaoDongList" isRead="true">
        <![CDATA[
            SELECT 
	           	dd.id,
                dd.company_id AS companyId,
                dd.user_id AS userId,
                dd.type AS type,
                DATE_FORMAT(dd.start_date, '%Y-%m-%d') AS startDate,
                o1.organ_name AS deptFrom,
                o2.organ_name AS deptTo,
                g1.gangwei_name AS gangweiFrom,
                g2.gangwei_name AS gangweiTo,
                o1.id AS deptFromId,
                o2.id AS deptToId,
                g1.id AS gangweiFromId,
                g2.id AS gangweiToId,
                zl1.id AS zhijiFromId,
                zl2.id AS zhijiToId,
                zl1.name AS zhijiFrom,
                zl2.name AS zhijiTo,
                DATE_FORMAT(dd.create_date, '%Y-%m-%d') AS createDate,
                dd.remark AS remark,
                dd.create_uid AS createUid,
                DATE_FORMAT(dd.update_date, '%Y-%m-%d') AS updateDate,
                dd.`status` AS `status`,
                dd.process_id AS processId,
                u.user_name AS userName,
                u2.user_name AS updateUid,
                u.emp_no AS empNo,
                DATE_FORMAT(u.entry_date, '%Y-%m-%d') AS entryDate,
                DATE_FORMAT(
                    u.entry_shop_date,
                    '%Y-%m-%d'
                ) AS entryShopDate
                <#if selfFields??  && selfFields?size gt 0>
                    ,
                    <#list selfFields as selfField>
                        ext.${selfField}
                        <#if selfField_has_next>,</#if>
                    </#list>
                </#if>
            FROM `t_diaodong` dd
                LEFT JOIN wec_user u on u.id = dd.user_id
                LEFT JOIN t_ext_t_diaodong ext on ext.id = dd.id
                LEFT JOIN t_organ o1 ON dd.dept_from = o1.id
                LEFT JOIN t_organ o2 ON dd.dept_to = o2.id
                LEFT JOIN t_gangwei g1 ON dd.gangwei_from = g1.id
                LEFT JOIN t_gangwei g2 ON dd.gangwei_to = g2.id
                LEFT JOIN t_zhiwei_level zl1 ON dd.zhiji_from = zl1.id
                LEFT JOIN t_zhiwei_level zl2 ON dd.zhiji_to = zl2.id
                LEFT JOIN wec_user u2 ON dd.update_uid = u2.id
            WHERE dd.company_id = :companyId
            <#if userName?? && userName?length gt 0>
                AND u.user_name like concat('%', :userName, '%')
            </#if>
            <#if empNo?? && empNo?length gt 0>
                AND u.emp_no like concat('%', :empNo, '%')
            </#if>
            <#if userId?? && userId?length gt 0>
                AND dd.user_id = :userId
            </#if>
            <#if gangweiFrom?? && gangweiFrom?length gt 0>
                AND g1.gangwei_name like concat('%', :gangweiFrom, '%')
            </#if>
            <#if gangweiTo?? && gangweiTo?length gt 0>
                AND g2.gangwei_name  like concat('%', :gangweiTo, '%')
            </#if>
            <#if deptFrom?? && deptFrom?length gt 0>
                AND o1.organ_name like concat('%', :deptFrom, '%')
            </#if>
            <#if deptTo?? && deptTo?length gt 0>
                AND o2.organ_name like concat('%', :deptTo, '%')
            </#if>
            <#if status?? && status?size gt 0>
                AND dd.`status` in (:status)
                <#else>
                AND dd.`status` !=5
            </#if>
            <#if keyWord?? && keyWord?length gt 0>
                AND (u.user_name like concat('%', :keyWord, '%')
                OR u.emp_no like concat('%', :keyWord, '%')
                OR g1.gangwei_name like concat('%', :keyWord, '%')
                OR g2.gangwei_name like concat('%', :keyWord, '%')
                OR o1.organ_name like concat('%', :keyWord, '%')
                OR o2.organ_name like concat('%', :keyWord, '%'))
            </#if>
            <#if organIds?? && organIds?size gt 0>
                AND (dd.dept_from in (:organIds) OR dd.dept_to in (:organIds))
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>
            <#if functions??  && functions?size gt 0>
                AND (
                <#list functions as thisfunc>
                    <#if thisfunc??  && thisfunc?size gt 0>
                        (
                        <#list thisfunc as selffunc>
                            ${selffunc.sqlStr}
                            <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                                <#if selffunc.funcType = 0>
                                    <
                                </#if>
                                <#if selffunc.funcType = 1>
                                    =
                                </#if>
                                <#if selffunc.funcType = 2>
                                    >
                                </#if>
                                <#else>
                                    like
                                </#if>
                                '${selffunc.funcValue}'
                            <#if selffunc_has_next> and</#if>
                        </#list>
                        )
                        <#if thisfunc_has_next> or </#if>
                    </#if>
                </#list>
                )
            </#if>
            order by dd.create_date desc
        ]]>
    </sql>

    <sql id="findCountsGroupByStatus" isRead="true">
        <![CDATA[
            select dd.status, count(dd.status) as counts
            FROM t_diaodong dd
            LEFT JOIN wec_user u on u.id = dd.user_id
            LEFT JOIN t_ext_t_diaodong tetd on tetd.id = dd.id
            LEFT JOIN t_organ o1 ON dd.dept_from = o1.id
            LEFT JOIN t_organ o2 ON dd.dept_to = o2.id
            LEFT JOIN t_gangwei g1 ON dd.gangwei_from = g1.id
            LEFT JOIN t_gangwei g2 ON dd.gangwei_to = g2.id
            WHERE dd.company_id = :companyId
            AND dd.`status` !=5
            <#if keyWord?? && keyWord?length gt 0>
                AND (u.user_name like concat('%', :keyWord, '%')
                OR u.emp_no like concat('%', :keyWord, '%')
                OR g1.gangwei_name like concat('%', :keyWord, '%')
                OR g2.gangwei_name like concat('%', :keyWord, '%')
                OR o1.organ_name like concat('%', :keyWord, '%')
                OR o2.organ_name like concat('%', :keyWord, '%'))
            </#if>
            <#if organIds?? && organIds?size gt 0>
                AND (dd.dept_from in (:organIds) OR dd.dept_to in (:organIds))
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>
            <#if functions??  && functions?size gt 0>
                and
                (
                <#list functions as thisfunc>
                <#if thisfunc??  && thisfunc?size gt 0>
                (
                <#list thisfunc as selffunc>
                ${selffunc.sqlStr}
                <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                <#if selffunc.funcType = 0> < </#if>
                <#if selffunc.funcType = 1> = </#if>
                <#if selffunc.funcType = 2> > </#if>
                <#else> like </#if>
                '${selffunc.funcValue}'
                <#if selffunc_has_next> and </#if>
                </#list>
                )
                <#if thisfunc_has_next> or </#if>
                </#if>
                </#list>
                )
            </#if>
            group by dd.status
        ]]>
    </sql>
    <sql id="delete">
        <![CDATA[
            update t_diaodong set status = :status, update_uid= :operatorId, update_date = SYSDATE()
            where id = :id and company_id = :companyId and status = 5
        ]]>
    </sql>

    <sql id="checkApplyCountByUserId" isRead="true">
        <![CDATA[
            select count(1) as count from t_diaodong where user_id = :userId
            <#if bizId?? && bizId?length gt 0>
                AND id != :bizId
            </#if>
            and company_id = :companyId and status in ( 0 , 10 );
        ]]>
    </sql>

    <sql id="getDiaodongLastStartDate" isRead="true">
        <![CDATA[
            SELECT
              MAX(dd.start_date) lastStartDate
            FROM
              t_diaodong dd
            WHERE dd.status IN (0, 10, 60, 70)
              AND dd.user_id = :userId
              AND dd.company_id = :companyId
            <#if bizId?? && bizId?length gt 0>
              AND id != :bizId
            </#if>
			]]>
    </sql>

    <sql id="updateApproveDiaoDong">
        <![CDATA[
		    UPDATE ${filedValues.tableName}
		        SET ${filedValues.filed} = '${filedValues.value}'
		    WHERE
			    id = :id
		]]>
    </sql>


    <sql id="findDiaoDongById" isRead="true">
        <![CDATA[
		   SELECT
	           	dd.id,
                dd.company_id AS companyId,
                dd.user_id AS userId,
                dd.start_date AS startDate,
                dd.process_id AS processId,
                dd.salary_pay_type AS salaryPayType,
                dd.type AS type,
                o1.organ_name AS deptFrom,
                o2.organ_name AS deptTo,
                g1.gangwei_name AS gangweiFrom,
                g2.gangwei_name AS gangweiTo,
                o1.id AS deptFromId,
                o2.id AS deptToId,
                g1.id AS gangweiFromId,
                g2.id AS gangweiToId,
                zl1.id AS zhijiFromId,
                zl2.id AS zhijiToId,
                zl1.name AS zhijiFrom,
                zl2.name AS zhijiTo,
                dd.create_date AS createDate,
                dd.remark,
                dd.salary_adjustment_id salaryAdjustmentId,
                dd.create_uid AS createUid,
                dd.update_uid AS updateUid,
                dd.update_date updateDate,
                dd.status,
                u.user_name AS userName,
                u.emp_no AS empNo,
                u.entry_date AS entryDate,
                u.entry_shop_date AS entryShopDate
                <#if customFieldStr??>${customFieldStr}</#if>
            FROM `t_diaodong` dd
            LEFT JOIN t_ext_t_diaodong ON t_ext_t_diaodong.id = dd.id
            LEFT JOIN wec_user u on u.id = dd.user_id
            LEFT JOIN t_organ o1 ON dd.dept_from = o1.id
            LEFT JOIN t_organ o2 ON dd.dept_to = o2.id
            LEFT JOIN t_gangwei g1 ON dd.gangwei_from = g1.id
            LEFT JOIN t_gangwei g2 ON dd.gangwei_to = g2.id
            LEFT JOIN t_zhiwei_level zl1 ON dd.zhiji_from = zl1.id
            LEFT JOIN t_zhiwei_level zl2 ON dd.zhiji_to = zl2.id
            where dd.id = :id and dd.company_id = :companyId
            limit 1
		]]>
    </sql>


    <sql id="findAllUserToDiaoDong" isRead="true">
        <![CDATA[
            SELECT
                *
            FROM
                t_diaodong
            WHERE
                start_date = :today
	            AND `status` in (:diaoDongStatus)
	            GROUP BY user_id
	            ORDER BY create_date DESC
        ]]>
    </sql>

    <sql id="getDiaodongLastRecordInTime" isRead="true">
        <![CDATA[
            SELECT
                d.user_id userId,
                d.start_date effectDate,
                d.dept_to organId,
                d.gangwei_to gangweiId,
                u.zhiwei_id zhiweiId,
                u.user_status userStatus
            FROM
                t_diaodong d
                left join wec_user u on u.id = d.user_id
            WHERE
                d.user_id = :userId and ( d.start_date >= :startDate and d.start_date <= :endDate)
	            AND d.`status` in (60,70)
	            order by d.start_date desc limit 1
        ]]>
    </sql>

    <sql id="getDiaoDongEarlyDayByDate" isRead="true">
        <![CDATA[
        select
            id, start_date,user_id,dept_from,dept_to,gangwei_to,gangwei_from,zhiji_from,zhiji_to,
            salary_pay_type,salary_dept_option
        from
            t_diaodong
        where
            user_id = :userId and start_date > :date and `status` in (60,70)
            order by start_date asc limit 1
        ]]>
    </sql>

    <sql id="getDiaodongRecordList" isRead="true">
        <![CDATA[
            SELECT
                d.user_id userId,
                d.start_date effectDate,
                d.dept_from deptFrom,
                d.gangwei_from gangweiFrom,
                gg.zhiwei_id zhiweiFrom,
                d.dept_to deptTo,
                d.gangwei_to gangweiTo,
                g.zhiwei_id zhiweiTo,
                d.salary_pay_type salary,
                d.salary_dept_option salaryDeptOption
            FROM
                t_diaodong d
                left join t_gangwei g on g.id = d.gangwei_to
                left join t_gangwei gg on gg.id = d.gangwei_from
            WHERE
                d.user_id = :userId
                and d.company_id = :companyId
                and (d.start_date >= :startDate and d.start_date <= :endDate)
                and d.status in (60,70)
                order by d.start_date asc
        ]]>
    </sql>

    <sql id="getLatestDiaodongAfterDate" isRead="true">
        <![CDATA[
        SELECT d.start_date,d.user_id, d.dept_from, d.dept_to, d.salary_pay_type FROM t_diaodong d
            WHERE
                d.user_id = :userId and d.company_id = :companyId and start_date >= :dateStr AND d.`status` in (60,70)
                order by d.start_date asc limit 1
                
        ]]>
    </sql>
    <sql id="getDiaoDongRecordBeforeDay" isRead="true">
        <![CDATA[
        select
            id, start_date,user_id,dept_from,dept_to,gangwei_to,gangwei_from
        from
            t_diaodong
        where
            user_id = :userId and start_date < :startDate and `status` in (60,70)
            order by start_date desc limit 1

        ]]>
    </sql>
    <sql id="findNeedRepairData" isRead="true">
        <![CDATA[
            SELECT
                a.*
            FROM
                t_diaodong a
                LEFT JOIN wec_user b ON b.id = a.user_id
            WHERE
                a.`status` IN ( 60, 70 )
                AND a.start_date <= date_format(now(),'%y-%m-%d')
                AND ( a.dept_to != b.organ_id OR a.gangwei_to != b.gangwei_id )
            GROUP BY
                a.user_id
            ORDER BY
                a.start_date DESC,
                a.create_date DESC
        ]]>
    </sql>

</sqlMap>