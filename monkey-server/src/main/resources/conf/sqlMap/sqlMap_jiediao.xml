<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="JieDiao">
    <sql id="findById">
        <![CDATA[select * from t_jiediao where id = :id]]>
    </sql>
    <sql id="findJieDiaoList" isRead="true">
        <![CDATA[
            SELECT
                jd.id AS id,
                jd.company_id AS companyId,
                jd.user_id AS userId,
                jd.type AS type,
                jd.terminate_date AS terminateDate,
                jd.start_date AS startDate,
                jd.over_date AS overDate,
                jd.salary AS salary,
                jd.kaoqin_id AS kaoqinId,
                jd.process_id AS processId,
                o1.organ_name AS deptFrom,
                o2.organ_name AS deptTo,
                g1.gangwei_name AS gangweiFrom,
                g2.gangwei_name AS gangweiTo,
                o1.id AS deptFromId,
                o2.id AS deptToId,
                g1.id AS gangweiFromId,
                g2.id AS gangweiToId,
                DATE_FORMAT(jd.create_date, '%Y-%m-%d') AS createDate,
                jd.remark AS remark,
                jd.create_uid AS createUid,
                DATE_FORMAT(jd.update_date, '%Y-%m-%d') AS updateDate,
                jd.`status` AS `status`,
                u.user_name AS userName,
                u2.user_name AS updateUid,
                u.emp_no AS empNo,
                DATE_FORMAT(u.entry_date, '%Y-%m-%d') AS entryDate,
                DATE_FORMAT(
                    u.entry_shop_date,
                    '%Y-%m-%d'
                ) AS entryShopDate
                <#if selfFields??  && selfFields?size gt 0>
                    ,
                    <#list selfFields as selfField>
                        jdext.${selfField}
                        <#if selfField_has_next>,</#if>
                    </#list>
                </#if>
            
            FROM `t_jiediao` jd
                LEFT JOIN wec_user u on u.id = jd.user_id
                LEFT JOIN t_ext_t_jiediao jdext on jdext.id = jd.id
                LEFT JOIN t_organ o1 ON jd.dept_from = o1.id
                LEFT JOIN t_organ o2 ON jd.dept_to = o2.id
                LEFT JOIN t_gangwei g1 ON jd.gangwei_from = g1.id
                LEFT JOIN t_gangwei g2 ON jd.gangwei_to = g2.id
                LEFT JOIN wec_user u2 ON jd.update_uid = u2.id
            WHERE jd.company_id = :companyId
        
            <#if type?? && type?length gt 0>
                AND jd.type = :type
            </#if>
            <#if userName?? && userName?length gt 0>
                AND u.user_name like concat('%', :userName, '%')
            </#if>
            <#if empNo?? && empNo?length gt 0>
                AND u.emp_no like concat('%', :empNo, '%')
            </#if>
            <#if userId?? && userId?length gt 0>
                AND u.id = :userId
            </#if>
            <#if gangweiFrom?? && gangweiFrom?length gt 0>
                AND g1.gangwei_name like concat('%', :gangweiFrom, '%')
            </#if>
            <#if gangweiTo?? && gangweiTo?length gt 0>
                AND g2.gangwei_name  like concat('%', :gangweiTo, '%')
            </#if>
            <#if deptFrom?? && deptFrom?length gt 0>
                AND o1.organ_name like concat('%', :deptFrom, '%')
            </#if>
            <#if deptTo?? && deptTo?length gt 0>
                AND o2.organ_name like concat('%', :deptTo, '%')
            </#if>
            <#if startDate?? && startDate?length gt 0>
                AND jd.start_date >= :startDate
            </#if>
            <#if overDate?? && overDate?length gt 0>
                AND jd.over_date <= :overDate
            </#if>
            <#if status?? && status?size gt 0>
                AND jd.`status` in (:status)
                <#else>
                AND jd.`status` != 5
            </#if>
            <#if keyWord?? && keyWord?length gt 0>
                AND (u.user_name like concat('%', :keyWord, '%')
                OR u.emp_no like concat('%', :keyWord, '%')
                OR g1.gangwei_name like concat('%', :keyWord, '%')
                OR g2.gangwei_name like concat('%', :keyWord, '%')
                OR o1.organ_name like concat('%', :keyWord, '%')
                OR o2.organ_name like concat('%', :keyWord, '%'))
            </#if>
            <#if organIds?? && organIds?size gt 0>
                AND ( jd.dept_from in (:organIds) OR jd.dept_to in (:organIds))
            </#if>
            <#if dataRange??  && dataRange?length gt 0>
                ${dataRange}
            </#if>

            <#if functions??  && functions?size gt 0>
                and (
                <#list functions as thisfunc>
                    <#if thisfunc??  && thisfunc?size gt 0>
                        (
                        <#list thisfunc as selffunc>
                            ${selffunc.sqlStr}
                            <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                                <#if selffunc.funcType = 0>
                                    <
                                </#if>
                                <#if selffunc.funcType = 1>
                                    =
                                </#if>
                                <#if selffunc.funcType = 2>
                                    >
                                </#if>
                                <#else>
                                    like
                                </#if>
                                '${selffunc.funcValue}'
                            <#if selffunc_has_next> and</#if>
                        </#list>
                        )
                        <#if thisfunc_has_next> or </#if>
                    </#if>
                </#list>
                )
            </#if>
            order by jd.create_date desc
        ]]>
    </sql>

    <sql id="findCountsGroupByStatus" isRead="true">
        <![CDATA[
            SELECT jd.status, count(jd.status) as counts
            FROM t_jiediao jd
                LEFT JOIN wec_user u on u.id = jd.user_id
                LEFT JOIN t_ext_t_jiediao jdext on jdext.id = jd.id
                LEFT JOIN t_organ o1 ON jd.dept_from = o1.id
                LEFT JOIN t_organ o2 ON jd.dept_to = o2.id
                LEFT JOIN t_gangwei g1 ON jd.gangwei_from = g1.id
                LEFT JOIN t_gangwei g2 ON jd.gangwei_to = g2.id
            WHERE jd.company_id = :companyId
                AND jd.`status` != 5
                <#if type?? && type?length gt 0>
                    AND jd.type = :type
                </#if>
                <#if keyWord?? && keyWord?length gt 0>
                    AND (u.user_name like concat('%', :keyWord, '%')
                    OR u.emp_no like concat('%', :keyWord, '%')
                    OR g1.gangwei_name like concat('%', :keyWord, '%')
                    OR g2.gangwei_name like concat('%', :keyWord, '%')
                    OR o1.organ_name like concat('%', :keyWord, '%')
                    OR o2.organ_name like concat('%', :keyWord, '%'))
                </#if>
                <#if organIds?? && organIds?size gt 0>
                    AND ( jd.dept_from in (:organIds) OR jd.dept_to in (:organIds))
                </#if>
                <#if dataRange??  && dataRange?length gt 0>
                    ${dataRange}
                </#if>
                <#if functions??  && functions?size gt 0>
                and
                (
                <#list functions as thisfunc>
                <#if thisfunc??  && thisfunc?size gt 0>
                (
                <#list thisfunc as selffunc>
                ${selffunc.sqlStr}
                <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                <#if selffunc.funcType = 0> < </#if>
                <#if selffunc.funcType = 1> = </#if>
                <#if selffunc.funcType = 2> > </#if>
                <#else> like </#if>
                '${selffunc.funcValue}'
                <#if selffunc_has_next> and </#if>
                </#list>
                )
                <#if thisfunc_has_next> or </#if>
                </#if>
                </#list>
                )
            </#if>
            group by jd.status
        ]]>
    </sql>

    <sql id="delete">
        <![CDATA[
            update t_jiediao set status = :status, update_uid= :operatorId, update_date = SYSDATE()
            where id = :id and company_id = :companyId and `status` = 3
        ]]>
    </sql>

    <sql id="findJieDiaoByDate" isRead="true">
        <![CDATA[
            select * from t_jiediao where user_id = :userId AND
            (
                :date BETWEEN start_date AND over_date
                OR
                :date BETWEEN start_date AND terminate_date
            )
            AND company_id = :companyId AND `status` !=5 limit 1;
        ]]>
    </sql>

    <sql id="checkApplyCountByUserId" isRead="true">
        <![CDATA[
            select count(1) as count from t_jiediao where user_id = :userId AND
            (
                :startDate BETWEEN start_date AND over_date
                 OR
                :overDate BETWEEN start_date AND terminate_date
            )
            <#if bizId?? && bizId?length gt 0>
                AND id != :bizId
            </#if>
            AND company_id = :companyId AND status !=5;
        ]]>
    </sql>

    <sql id="queryJieDiaoCountByUserId" isRead="true">
        <![CDATA[
            SELECT
                COUNT(1) as count
            FROM
                t_jiediao
            WHERE
                `status` in (60,70) and company_id= :companyId and user_id = :userId AND NOW() <= over_date AND NOW() >= start_date
        ]]>
    </sql>

    <sql id="queryJieDiaoLastTime" isRead="true">
        <![CDATA[
            SELECT
              MAX(
                IFNULL(jd.terminate_date, jd.over_date)
              ) lastOverTime
            FROM
              t_jiediao jd
            WHERE jd.status IN (0, 10, 60, 70)
              AND jd.user_id = :userId
              AND jd.company_id = :companyId
            <#if bizId?? && bizId?length gt 0>
              AND id != :bizId
            </#if>
        ]]>
    </sql>

    <sql id="updateApproveJieDiao">
        <![CDATA[
            UPDATE ${filedValues.tableName}
                SET ${filedValues.filed} = '${filedValues.value}'
            WHERE
                id = :id
        ]]>
    </sql>

    <sql id="findJieDiaoById" isRead="true">
        <![CDATA[
            SELECT jd.id as id, jd.company_id as companyId, jd.user_id as userId, jd.start_date as startDate,
                jd.over_date as overDate, jd.salary as salary, jd.type as type, jd.kaoqin_id as kaoqinId,
                jd.terminate_date AS terminateDate,
                jd.finish_reason AS finishReason,
                jd.process_id AS processId,
                o1.organ_name AS deptFrom,
                o2.organ_name AS deptTo,
                g1.gangwei_name AS gangweiFrom,
                g2.gangwei_name AS gangweiTo,
                o1.id AS deptFromId,
                o2.id AS deptToId,
                g1.id AS gangweiFromId,
                g2.id AS gangweiToId,
                jd.create_date as createDate, jd.remark as remark, jd.create_uid as createUid,
                jd.update_uid as updateUid, jd.update_date as updateDate, jd.status as status,
                u.user_name as userName, u.emp_no as empNo
                <#if customFieldStr??>${customFieldStr}</#if>
            FROM `t_jiediao` jd
            LEFT JOIN t_ext_t_jiediao ON t_ext_t_jiediao.id = jd.id
            left join wec_user u on u.id = jd.user_id
            LEFT JOIN t_organ o1 ON jd.dept_from = o1.id
            LEFT JOIN t_organ o2 ON jd.dept_to = o2.id
            LEFT JOIN t_gangwei g1 ON jd.gangwei_from = g1.id
            LEFT JOIN t_gangwei g2 ON jd.gangwei_to = g2.id

            where jd.id = :id and jd.company_id = :companyId
        ]]>
    </sql>
    
    <sql id="getJiediaoByDates" isRead="true">
        <![CDATA[
            SELECT
                id, company_id, user_id,
                DATE_FORMAT(start_date,'%Y-%m-%d') as start_date,
                DATE_FORMAT(IFNULL( terminate_date, over_date ),'%Y-%m-%d') as over_date,
                salary,salary_dept_option, type, kaoqin_id, dept_from, dept_to, gangwei_to, gangwei_from
            FROM
                t_jiediao
            WHERE
                user_id = :userId
                AND `status` IN ( 60, 70 )
                AND `type` = 1
                AND (( DATE_FORMAT( start_date, '%Y-%m-%d' ) >= :startDate and DATE_FORMAT( start_date, '%Y-%m-%d' ) <= :endDate )
                or ( DATE_FORMAT( IFNULL( terminate_date, over_date ),'%Y-%m-%d' ) >= :startDate and DATE_FORMAT( IFNULL( terminate_date, over_date ), '%Y-%m-%d' ) <= :endDate ))
            order by start_date asc
        ]]>
    </sql>

    <sql id="checkJieDiaoEndDayByDate" isRead="true">
        <![CDATA[
            select
                id, company_id, user_id, start_date, DATE_FORMAT(IFNULL( terminate_date, over_date ),'%Y-%m-%d') as over_date,
                salary, type, kaoqin_id, dept_from, dept_to, gangwei_to, gangwei_from,salary_dept_option
            from  t_jiediao
            where
                user_id = :userId
                AND `status` IN ( 60, 70 )
                AND `type` = 1
                and (DATE_FORMAT( IFNULL( terminate_date, over_date ),'%Y-%m-%d' ) = :endDate)
        ]]>
    </sql>

    <sql id="findTodayJiediao" isRead="true">
        <![CDATA[
        SELECT *  FROM `t_jiediao` t WHERE DATE(t.start_date)=CURDATE() AND t.status IN(60,70)
        ]]>
    </sql>

    <sql id="findShixiaoJiediao" isRead="true">
        <![CDATA[
        SELECT * FROM t_jiediao t WHERE (DATE(DATE_SUB(t.terminate_date,INTERVAL -1 DAY))=CURDATE()) OR (DATE(DATE_SUB(t.over_date,INTERVAL -1 DAY))=CURDATE() AND t.status IN(60,70))
        ]]>
    </sql>

    <sql id="findJiediaoUserIdsInOrganIds" isRead="true">
        <![CDATA[
        SELECT distinct(user_id) FROM t_jiediao 
        WHERE if(terminate_date is null, over_date > now(), (over_date > now() and terminate_date > now()))
        and (status = 60 or status = 70)
        and dept_to in (:organIds)
        ]]>
    </sql>
</sqlMap>