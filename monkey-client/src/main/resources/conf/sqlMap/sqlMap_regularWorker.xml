<?xml version="1.0" encoding="UTF-8"?>
<sqlMap namespace="RegularWorker">
    <sql id="findRegularWorkerList" isRead="true">
        <![CDATA[
                SELECT
                   	u.id AS userId,
                    u.emp_no AS empNo,
                    u.user_name AS userName,
                    u2.user_name AS updateUid,
                    DATE_FORMAT(rw.update_date, '%Y-%m-%d') AS updateDate,
                    DATE_FORMAT(u.entry_date, '%Y-%m-%d') AS entryDate,
                    DATE_FORMAT(
                        u.entry_shop_date,
                        '%Y-%m-%d'
                    ) AS entryShopDate,
                    DATE_FORMAT(
                        u.expect_regular_date,
                        '%Y-%m-%d'
                    ) AS expectRegularDate,
                    u.gangwei_id AS gangweiId,
                    gw.gangwei_name AS gangweiName,
                    o.id AS organId,
                    o.organ_name AS organName,
                    rw.id AS id,
                    rw.company_id AS companyId,
                    IFNULL(rw.`status`, 100) AS `status`,
                    DATE_FORMAT(rw.regular_date, '%Y-%m-%d') AS regularDate,
                    rw.create_uid AS createUid,
                    rw.process_id AS processId
                    <#if selfFields??  && selfFields?size gt 0>
                        ,
                        <#list selfFields as selfField>
                            t_ext_rw.${selfField}
                            <#if selfField_has_next>,</#if>
                        </#list>
                    </#if>
                FROM
                    wec_user u
                LEFT JOIN t_regular_worker rw ON u.id = rw.user_id
                LEFT JOIN t_gangwei gw ON u.gangwei_id = gw.id
                LEFT JOIN t_organ o ON u.organ_id = o.id
                LEFT JOIN wec_user u2 ON rw.update_uid = u2.id
                LEFT JOIN t_ext_t_regular_worker t_ext_rw ON rw.id = t_ext_rw.id

                WHERE u.company_id = :companyId AND u.`status` = 0 AND u.`user_status` In (10,20)
                    <#if userName?? && userName?length gt 0>
                        AND u.user_name like concat('%', :userName, '%')
                    </#if>
                    <#if userId?? && userId?length gt 0>
                        AND u.id = :userId
                    </#if>
                    <#if empNo?? && empNo?length gt 0>
                        AND u.emp_no like concat('%', :empNo, '%')
                    </#if>
                    <#if deptName?? && deptName?length gt 0>
                        AND o.organ_name like concat('%', :deptName, '%')
                    </#if>
                    <#if gangweiName?? && gangweiName?length gt 0>
                        AND gw.gangwei_name like concat('%', :gangweiName, '%')
                    </#if>
                    <#if statusParam?? && statusParam?length gt 0>
                        ${statusParam }
                    </#if>
                    <#if keyWord?? && keyWord?length gt 0>
                        AND (u.user_name like concat('%', :keyWord, '%')
                        OR gw.gangwei_name like concat('%', :keyWord, '%')
                        OR o.organ_name like concat('%', :keyWord, '%')
                        OR u.emp_no like concat('%', :keyWord, '%'))
                    </#if>
                    <#if organIds?? && organIds?size gt 0>
                        AND o.id in (:organIds)
                    </#if>
                    <#if dataRange??  && dataRange?length gt 0>
                        ${dataRange}
                    </#if>
                    <#if functions??  && functions?size gt 0>
                        and
                        (
                        <#list functions as thisfunc>
                        <#if thisfunc??  && thisfunc?size gt 0>
                        (
                        <#list thisfunc as selffunc>
                        ${selffunc.sqlStr}
                        <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                        <#if selffunc.funcType = 0> < </#if>
                        <#if selffunc.funcType = 1> = </#if>
                        <#if selffunc.funcType = 2> > </#if>
                        <#else> like </#if>
                        '${selffunc.funcValue}'
                        <#if selffunc_has_next> and </#if>
                        </#list>
                        )
                        <#if thisfunc_has_next> or </#if>
                        </#if>
                        </#list>
                        )
                    </#if>
                order by rw.create_date,u.entry_date desc

        ]]>
    </sql>
    <sql id="findRegularWorkerListForEmpManagerPage" isRead="true">
        <![CDATA[
                SELECT
                   	u.id AS userId,
                    u.emp_no AS empNo,
                    u.user_name AS userName,
                    u2.user_name AS updateUid,
                    DATE_FORMAT(rw.update_date, '%Y-%m-%d') AS updateDate,
                    DATE_FORMAT(u.entry_date, '%Y-%m-%d') AS entryDate,
                    DATE_FORMAT(
                        u.entry_shop_date,
                        '%Y-%m-%d'
                    ) AS entryShopDate,
                    DATE_FORMAT(
                        u.expect_regular_date,
                        '%Y-%m-%d'
                    ) AS expectRegularDate,
                    u.gangwei_id AS gangweiId,
                    gw.gangwei_name AS gangweiName,
                    o.id AS organId,
                    o.organ_name AS organName,
                    rw.id AS id,
                    rw.company_id AS companyId,
                    rw.`status`,
                    DATE_FORMAT(rw.regular_date, '%Y-%m-%d') AS regularDate,
                    rw.create_uid AS createUid,
                    rw.process_id AS processId
                FROM
                    wec_user u
                LEFT JOIN t_regular_worker rw ON u.id = rw.user_id
                LEFT JOIN t_gangwei gw ON u.gangwei_id = gw.id
                LEFT JOIN t_organ o ON u.organ_id = o.id
                LEFT JOIN wec_user u2 ON rw.update_uid = u2.id
                WHERE u.company_id = :companyId
                AND u.id = :userId
                AND u.`status` = 0
                AND u.`user_status` NOT IN (10,20)
                AND rw.`status` IN (60,70)
                order by rw.create_date,u.entry_date desc
        ]]>
    </sql>
    <!-- rw.`status` 为空表示待转正的用户(状态100) -->
    <sql id="findCountsGroupByStatus" isRead="true">
        <![CDATA[
            SELECT
                IFNULL(rw.`status`, 100) AS `status`,
                COUNT(IFNULL(rw.`status`, 1)) AS counts
            FROM
                wec_user u
            LEFT JOIN t_regular_worker rw ON rw.user_id = u.id
            LEFT JOIN t_gangwei gw ON u.gangwei_id = gw.id
            LEFT JOIN t_organ o ON u.organ_id = o.id
            LEFT JOIN wec_user u2 ON rw.update_uid = u2.id
            LEFT JOIN t_ext_t_regular_worker t_ext_rw ON rw.id = t_ext_rw.id
            WHERE
                u.`status` = 0 AND u.company_id = :companyId AND u.`user_status` In (10,20)
                <#if keyWord?? && keyWord?length gt 0>
                     AND (u.user_name like concat('%', :keyWord, '%')
                     OR gw.gangwei_name like concat('%', :keyWord, '%')
                     OR o.organ_name like concat('%', :keyWord, '%')
                     OR u.emp_no like concat('%', :keyWord, '%'))
                </#if>
                <#if organIds?? && organIds?size gt 0>
                     AND o.id in (:organIds)
                </#if>
                <#if dataRange??  && dataRange?length gt 0>
                     ${dataRange}
                </#if>
                <#if functions??  && functions?size gt 0>
                        and
                        (
                        <#list functions as thisfunc>
                        <#if thisfunc??  && thisfunc?size gt 0>
                        (
                        <#list thisfunc as selffunc>
                        ${selffunc.sqlStr}
                        <#if selffunc.funcType??  && selffunc.funcType?length gt 0>
                        <#if selffunc.funcType = 0> < </#if>
                        <#if selffunc.funcType = 1> = </#if>
                        <#if selffunc.funcType = 2> > </#if>
                        <#else> like </#if>
                        '${selffunc.funcValue}'
                        <#if selffunc_has_next> and </#if>
                        </#list>
                        )
                        <#if thisfunc_has_next> or </#if>
                        </#if>
                        </#list>
                        )
                    </#if>
            GROUP BY
                rw.`status`
        ]]>
    </sql>
    <!--<#if dataRange?? && dataRange?length gt 0>-->
    <!--${dataRange}-->
    <!--</#if>-->

    <sql id="findRegularInfoById" isRead="true">
        <![CDATA[
            SELECT
            rw.id AS id,
            rw.company_id AS companyId,
            rw.user_id AS userId,
            rw.`status` AS `status`,
            rw.regular_date AS regularDate,
            rw.process_id AS processId,
            u.emp_no AS empNo,
            u.user_name AS userName,
            u.entry_date AS entryDate,
            u.entry_shop_date AS entryShopDate,
            u.expect_regular_date AS expectRegularDate,
            u.gangwei_id AS gangweiId,
            gw.gangwei_name AS gangweiName,
            o.id AS organId,
            o.organ_name AS organName,
            rw.remark as remark
            <#if customFieldStr??>${customFieldStr}</#if>
            FROM
            t_regular_worker rw
            LEFT JOIN t_ext_t_regular_worker ON t_ext_t_regular_worker.id = rw.id
            LEFT JOIN wec_user u ON rw.user_id = u.id
            LEFT JOIN t_gangwei gw ON u.gangwei_id = gw.id
            LEFT JOIN t_organ o ON u.organ_id = o.id
            WHERE rw.id = :id AND rw.company_id = :companyId
        ]]>
    </sql>

    <sql id="checkApplyCountByUserId" isRead="true">
        <![CDATA[
            SELECT
                COUNT(1)
            FROM
                t_regular_worker rw
                LEFT JOIN wec_user u ON rw.user_id = u.id
            WHERE
                rw.company_id = :companyId
                AND rw.user_id = :userId

                <#if bizId?? && bizId?length gt 0>
                    AND rw.id != :bizId
                </#if>

                AND rw.`status` <> 5
                AND u.user_status <> 60
        ]]>
    </sql>

    <sql id="updateApproveRegularWorker">
        <![CDATA[
		    UPDATE ${filedValues.tableName}
		        SET ${filedValues.filed} = '${filedValues.value}'
		    WHERE
			    id = :id
		]]>
    </sql>

    <sql id="findAllUserToRegular" isRead="true">
        <![CDATA[
            SELECT
                rw.id,
                rw.regular_date,
                rw.user_id
            FROM
                t_regular_worker rw
            LEFT JOIN wec_user u ON rw.user_id = u.id
            WHERE
                regular_date <= :today
                AND u.`status` = 0
                AND rw.`status` in (:regularStatus)
                AND u.user_status IN (20, 10)
        ]]>
    </sql>

    <sql id="checkRegularByUserId" isRead="true">
        SELECT
        id
        FROM
        t_regular_worker
        WHERE
        user_id = :userId
        AND company_id = :companyId
        AND `status` = :status
    </sql>
    <sql id="getRegularRecordInTime" isRead="true">
        <![CDATA[
            select
                r.user_id userId,
                r.regular_date effectDate,
                u.user_status userStatus,
                u.organ_id organId,
                u.zhiwei_id zhiweiId
            from
                t_regular_worker r
                left join wec_user u on u.id = r.user_id
            where
                user_id = :userId and
                (regular_date >= :startDate and regular_date <= :endDate)
        ]]>
    </sql>

    <sql id="todoRegularWorkerList" isRead="true">
        <![CDATA[
                SELECT
                   	u.id AS userId,
                    u.emp_no AS empNo,
                    u.user_name AS userName,
                    u2.user_name AS updateUid,
                    DATE_FORMAT(rw.update_date, '%Y-%m-%d') AS updateDate,
                    DATE_FORMAT(u.entry_date, '%Y-%m-%d') AS entryDate,
                    DATE_FORMAT(
                        u.entry_shop_date,
                        '%Y-%m-%d'
                    ) AS entryShopDate,
                    DATE_FORMAT(
                        u.expect_regular_date,
                        '%Y-%m-%d'
                    ) AS expectRegularDate,
                     if(u.expect_regular_date IS NOT NULL,TO_DAYS(u.expect_regular_date) - TO_DAYS(NOW()) ,66) expectRegularDays,
                    u.gangwei_id AS gangweiId,
                    gw.gangwei_name AS gangweiName,
                    o.id AS organId,
                    o.organ_name AS organName,
                    rw.id AS id,
                    rw.company_id AS companyId,
                    IFNULL(rw.`status`, 0) AS `status`,
                    DATE_FORMAT(rw.regular_date, '%Y-%m-%d') AS regularDate,
                    rw.create_uid AS createUid,
                    rw.process_id AS processId
                FROM
                    wec_user u
                LEFT JOIN t_regular_worker rw ON u.id = rw.user_id
                LEFT JOIN t_gangwei gw ON u.gangwei_id = gw.id
                LEFT JOIN t_organ o ON u.organ_id = o.id
                LEFT JOIN wec_user u2 ON rw.update_uid = u2.id
                LEFT JOIN t_ext_t_regular_worker t_ext_rw ON rw.id = t_ext_rw.id
                WHERE u.company_id = :companyId AND u.`status` = 0 AND u.user_status IN (10, 20) 
				AND ISNULL(rw.`status`)		
                <#if key?? && key?length gt 0>
                    AND (
	                    u.user_name like concat('%', :key, '%')
	                    OR gw.gangwei_name like concat('%', :key, '%')
	                    OR o.organ_name like concat('%', :key, '%')
	                    OR u.emp_no like concat('%', :key, '%')
                    )
                </#if>
                <#if dataRange??  && dataRange?length gt 0>
                     ${dataRange}
                </#if>
				AND IF(u.expect_regular_date IS NOT NULL,TO_DAYS(u.expect_regular_date) - TO_DAYS(NOW()) ,66) <= 30
                ORDER BY expectRegularDays
        ]]>
    </sql>
    
    <sql id="regularWorkerListH5" isRead="true">
        <![CDATA[
                SELECT
                   	u.id,
                    u.emp_no AS empNo,
                    u.user_name AS userName,
                    DATE_FORMAT(rw.update_date, '%Y-%m-%d') AS updateDate,
                    DATE_FORMAT(u.entry_date, '%Y-%m-%d') AS entryDate,
                    DATE_FORMAT(
                        u.entry_shop_date,
                        '%Y-%m-%d'
                    ) AS entryShopDate,
                    DATE_FORMAT(
                        u.expect_regular_date,
                        '%Y-%m-%d'
                    ) AS expectRegularDate,
                    u.gangwei_id AS gangweiId,
                    gw.gangwei_name AS gangweiName,
                    o.id AS organId,
                    o.organ_name AS organName,
                    rw.id AS regularWorkerId,
                    rw.company_id AS companyId,
                    IFNULL(rw.`status`, 0) AS `status`,
                    DATE_FORMAT(rw.regular_date, '%Y-%m-%d') AS regularDate,
                    rw.create_uid AS createUid,
                    rw.process_id AS processId
                FROM
                    wec_user u
                LEFT JOIN t_regular_worker rw ON u.id = rw.user_id
                LEFT JOIN t_gangwei gw ON u.gangwei_id = gw.id
                LEFT JOIN t_organ o ON u.organ_id = o.id
                WHERE u.company_id = :companyId AND u.`status` = 0
	                AND (u.user_status = 10 OR u.user_status = 20)
					AND ISNULL(rw.`status`)
				<#if keyWord?? && keyWord?length gt 0>
                	AND u.user_name like concat('%', :keyWord, '%')
                </#if>
                <#if dataRange??  && dataRange?length gt 0>
                     ${dataRange}
                </#if>
                ORDER BY u.emp_no
        ]]>
    </sql>
</sqlMap>