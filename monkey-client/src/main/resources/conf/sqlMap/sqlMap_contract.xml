<?xml version="1.0" encoding="UTF-8" ?>
<sqlMap namespace="Contract">

    <!-- 当前企业合同编码最大值 -->
    <sql id="getCodeNumByCompanyId" isRead="true">
        select max(code_num) from t_emp_contract where company_id = :companyId;
    </sql>

    <!-- 当前企业合同编码最大值 -->
    <sql id="getContractByMd5Code" isRead="true">
        select 1 from t_emp_contract where company_code_num =:md5Code
    </sql>

    <!-- 获取未签人数 -->
    <sql id="countNoSign" isRead="true">
        <![CDATA[
			SELECT
				count(1)
			FROM
				wec_user u
			LEFT JOIN t_gangwei g ON g.id = u.gangwei_id
			LEFT JOIN t_organ o ON o.id = u.organ_id
			WHERE
			 u.company_id = :companyId
			and u.`status` not in ('3','5') and u.user_status not in ('40','50')
			and u.id not in (select user_id from t_emp_contract where `status` = 0 and company_id = :companyId)
			<#if organIds?? && organIds?size gt 0>
				and u.organ_id in (:organIds)
			</#if>
		<#if filterStr??  && filterStr?length gt 0>
			and (
				u.user_name like concat('%',:filterStr,'%')
				or
				u.emp_no like concat('%',:filterStr,'%')
				or
				g.gangwei_name like concat('%',:filterStr,'%')
				or
				o.organ_name like concat('%',:filterStr,'%')
				)
		</#if>
		<#if dataRange??  && dataRange?length gt 0>
           	${dataRange}
       	</#if>
		<#if organIds?? && organIds?size gt 0>
			and u.organ_id in (:organIds)
		</#if>
				<#if functions??  && functions?size gt 0>
				and (
            	<#list functions as thisfunc>
            		<#if thisfunc??  && thisfunc?size gt 0>
	           		 	(
	           		 	<#list thisfunc as selffunc>
	           		 			${selffunc.sqlStr}  
	           		 			 	<#if selffunc.funcType??  && selffunc.funcType?length gt 0> 
	           		 			 		<#if selffunc.funcType = 0>
	           		 			 			<
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 1>
	           		 			 			=
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 2>
	           		 			 			>
	           		 			 		</#if> 
	           		 			 	<#else>
	           		 			 	 like
									</#if>  
	           		 			'${selffunc.funcValue}'
	           		 		<#if selffunc_has_next> and</#if>
	           		 	</#list>	           		 		           	       
           		 		)
           		 		<#if thisfunc_has_next> or </#if>
           		 	</#if>          		 	
        		</#list>
        		)
       		</#if>
			
		]]>
    </sql>

    <!-- 回显合同信息 -->
    <sql id="getContractInfo" isRead="true">
        <![CDATA[
			SELECT
				c.id,
				c.company_id companyId,
				u.user_name userName,
				u.id userId,
				u.emp_no empNo,
				t.organ_name organName,
				tg.gangwei_name gangweiName,
				tz.zhiwei_name zhiweiName,
				c.code_num codeNum,
				c.sign_num signNum,
				info.id infoId,
				info.contract_type type,
				info.contract_period period,
				c.contract_style style,
				info.contract_start_date startDate,
				info.contract_end_date endDate,
				info.contract_stop_date stopDate,
				info.remark description,
				tecd.description disdescription,
				tect.description stopdescription,
				c.status contractStatus,
				if(c.status!=0,c.status,info.status) status
			FROM
				t_emp_contract c
			LEFT JOIN
				t_emp_contract_info info ON info.contract_id = c.id
			<#if infoId?? && infoId?length gt 0>
				and info.id = :infoId
			<#else>
				and c.sign_num = info.status
			</#if> 
			LEFT JOIN wec_user u ON u.id = c.user_id
			left join t_emp_contract_dissolution tecd on tecd.contract_id=c.id
			left join t_emp_contract_termination tect on tect.contract_id=c.id
			left join t_organ t on t.id=u.organ_id
			left join t_gangwei tg on u.gangwei_id=tg.id and u.gangwei_id is not null
			left join t_zhiwei tz on tz.id=u.zhiwei_id and u.zhiwei_id is not null
			WHERE
				c.id =:contractId
		]]>
    </sql>

    <!-- 回显历史信息 -->
    <sql id="getContractHistory" isRead="true">
        select c.id,u.user_name userName,u.emp_no empNo,o.organ_name organName,
        g.gangwei_name gangweiName,c.code_num codeNum,c.contract_style style
        from t_emp_contract c
        LEFT JOIN wec_user u
        on u.id = c.user_id
        LEFT JOIN t_organ o
        on o.id = u.organ_id
        LEFT JOIN t_gangwei g
        on g.id = u.gangwei_id
        where c.id = :contractId
        and c.status != 5
    </sql>

    <!-- 回显历史信息详情 -->
    <sql id="getContractInfoHistory" isRead="true">
        SELECT
        id,
        contract_period period,
        contract_type type,
        contract_start_date startDate,
        contract_stop_date stopDate,
        contract_end_date endDate,
        remark description,
        `status`
        FROM
        t_emp_contract_info
        WHERE
        contract_id = :contractId
        order by contract_start_date
    </sql>

    <!-- 获取合同详情对象 -->
    <sql id="getEmpContractInfoByContractId" isRead="true">
        SELECT
        id,
        company_id,
        contract_id,
        contract_type,
        contract_period,
        contract_start_date,
        contract_end_date,
        contract_stop_date,
        remark as 'description',
        `status`,
        create_date,
        create_uid,
        update_date,
        update_uid
        FROM
        t_emp_contract_info
        where contract_id = :contractId
        and status != 5
        order by contract_start_date desc
        limit 1
    </sql>

    <!-- 获取合同详情对象 -->
    <sql id="getUserContract" isRead="true">
        SELECT
        id
        FROM
        t_emp_contract
        where user_id = :userId
        and company_id = :companyId
        and status = 0
        limit 1
    </sql>

    <!-- 查询未签人员 -->
    <sql id="getNoSignListPage" isRead="true">
        <![CDATA[
			SELECT
				u.id,
				u.user_name userName,
				u.emp_no empNo,
				u.organ_id organId,
				g.gangwei_name gangweiName,
				z.zhiwei_name zhiweiName,
				u.entry_date entryDate,
				u.`user_status` userStatus
			<#if selfFields??  && selfFields?size gt 0>
				,
            	<#list selfFields as selfField>
           		 	ext.${selfField}
           		 	<#if selfField_has_next>,</#if>
        		</#list>
       		</#if>
			FROM
				wec_user u
			LEFT JOIN t_gangwei g ON g.id = u.gangwei_id
			LEFT JOIN t_zhiwei z ON z.id = g.zhiwei_id
			LEFT JOIN t_organ o on o.id = u.organ_id
			WHERE
				u.company_id = :companyId
				and u.`status` not in ('3','5') and u.user_status not in ('40','50')
				and u.id not in (select user_id from t_emp_contract where `status` = 0 and company_id = :companyId )
		<#if filterStr??  && filterStr?length gt 0>
			and (
				u.user_name like concat('%',:filterStr,'%')
				or
				u.emp_no like concat('%',:filterStr,'%')
				or
				g.gangwei_name like concat('%',:filterStr,'%')
				or
				o.organ_name like concat('%',:filterStr,'%')
				)
		</#if>
		<#if dataRange??  && dataRange?length gt 0>
           	${dataRange}
        </#if>
		<#if organPaths?? && organPaths?length gt 0>
			AND o.organ_paths like CONCAT (:organPaths,'%')
		</#if>
		<#if functions??  && functions?size gt 0>
				and (
            	<#list functions as thisfunc>
            		<#if thisfunc??  && thisfunc?size gt 0>
	           		 	(
	           		 	<#list thisfunc as selffunc>
	           		 			${selffunc.sqlStr}  
	           		 			 	<#if selffunc.funcType??  && selffunc.funcType?length gt 0> 
	           		 			 		<#if selffunc.funcType = 0>
	           		 			 			<
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 1>
	           		 			 			=
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 2>
	           		 			 			>
	           		 			 		</#if> 
	           		 			 	<#else>
	           		 			 	 like
									</#if>  
	           		 			'${selffunc.funcValue}'
	           		 		<#if selffunc_has_next> and</#if>
	           		 	</#list>	           		 		           	       
           		 		)
           		 		<#if thisfunc_has_next> or </#if>
           		 	</#if>          		 	
        		</#list>
        		)
       		</#if>
		]]>
    </sql>

    <!-- 删除解除记录 -->
    <sql id="deleteDissolution">
        DELETE from t_emp_contract_dissolution where contract_id in (:ids)
    </sql>

    <!-- 删除扩展信息 -->
    <sql id="deleteContractExt">
        DELETE from t_ext_t_contract where id in (:ids)
    </sql>

    <!-- 删除终止记录 -->
    <sql id="deleteTermination">
        DELETE from t_emp_contract_termination where contract_id in (:ids)
    </sql>

    <!-- 删除解除记录 -->
    <sql id="deleteContract">
        UPDATE t_emp_contract set `STATUS` = 5 where id in (:ids)
    </sql>

    <!-- 删除解除记录 -->
    <sql id="deleteInfo">
        UPDATE t_emp_contract_info set `STATUS` = 5 where contract_id in (:ids)
    </sql>

    <!-- 合同到期时间查询 -->
    <sql id="getContractEndDate" isRead="true">
        <![CDATA[
			SELECT
				c.id,
				info.contract_stop_date stopDate,
				info.contract_end_date endDate
			FROM
				t_emp_contract c
			LEFT JOIN t_emp_contract_info info 
			ON info.contract_id = c.id and c.sign_num = info.status and info.status !=5
			LEFT JOIN wec_user u ON u.id = c.user_id
			LEFT JOIN t_gangwei g
			on g.id = u.gangwei_id	
			LEFT JOIN t_organ o
			on o.id = u.organ_id
			WHERE
				c.company_id = :companyId
			AND c.status != 5
			<#if  organIds?? && organIds?size gt 0>
				and u.organ_id in (:organIds)
			</#if>
			<#if filterStr?? && filterStr?length gt 0>
				and (
				u.user_name like concat('%',:filterStr,'%')
				or
				u.emp_no like concat('%',:filterStr,'%')
				or
				g.gangwei_name like concat('%',:filterStr,'%')
				or
				o.organ_name like concat('%',:filterStr,'%')
				)
			</#if>
			<#if dataRange??  && dataRange?length gt 0>
            	${dataRange}
        	</#if>
			<#if functions??  && functions?size gt 0>
				and (
            	<#list functions as thisfunc>
            		<#if thisfunc??  && thisfunc?size gt 0>
	           		 	(
	           		 	<#list thisfunc as selffunc>
	           		 			${selffunc.sqlStr}  
	           		 			 	<#if selffunc.funcType??  && selffunc.funcType?length gt 0> 
	           		 			 		<#if selffunc.funcType = 0>
	           		 			 			<
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 1>
	           		 			 			=
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 2>
	           		 			 			>
	           		 			 		</#if> 
	           		 			 	<#else>
	           		 			 	 like
									</#if>  
	           		 			'${selffunc.funcValue}'
	           		 		<#if selffunc_has_next> and</#if>
	           		 	</#list>	           		 		           	       
           		 		)
           		 		<#if thisfunc_has_next> or </#if>
           		 	</#if>          		 	
        		</#list>
        		)
       		</#if>
			
		]]>
    </sql>

    <sql id="addContractSelf">
        <![CDATA[
            INSERT INTO t_ext_t_contract(id,company_id,
            	<#list selfList as selfField>
            		${selfField.field}
            	<#if selfField_has_next> , </#if>
            	</#list>
            )
                VALUES (
                :contractId,:companyId,
                <#list selfList as selfField>
            		'${selfField.value}'
            	<#if selfField_has_next> , </#if>
            	</#list>
                )                        
        ]]>
    </sql>

    <sql id="updateContractSelf">
        <![CDATA[
            UPDATE t_ext_t_contract SET 
            <#list selfList as selfField>
            	${selfField.field} = '${selfField.value}'
            	<#if selfField_has_next> , </#if>
            </#list>         
			WHERE id = :contractId and  company_id = :companyId        
        ]]>
    </sql>

    <sql id="queryExtById">
        <![CDATA[
           select count(1) totalCount from t_ext_t_contract where id=:contractId
        ]]>
    </sql>


    queryExtRecord
    <sql id="removeDissolutionByContractId">
        <![CDATA[
          delete from t_emp_contract_dissolution where contract_id = :contractId     
        ]]>
    </sql>

    <sql id="dissolutionaContract">
        <![CDATA[
         UPDATE t_emp_contract
			SET `status` = 4
			WHERE
				id IN (
					SELECT
						t.id
					FROM
						(
							SELECT
								c.id
							FROM
								t_emp_contract c
							LEFT JOIN t_emp_contract_info info ON c.id = info.contract_id
							AND c.sign_num = info. STATUS
							AND info.`status` != 5
							WHERE
								c.`status` = 0
							AND contract_stop_date IS NOT NULL
							AND contract_stop_date < NOW()
						) t
				)     
        ]]>
    </sql>

    <!-- 回显合同信息 -->
    <sql id="getContractInfoSelf" isRead="true">
        <![CDATA[
			SELECT
				t_emp_contract.id,
				u.user_name userName,
				u.id userId,
				u.emp_no empNo,
				t.organ_name organName,
				tg.gangwei_name gangweiName,
				tz.zhiwei_name zhiweiName,
				t_emp_contract.code_num codeNum,
				t_emp_contract.sign_num signNum,
				t_emp_contract.id infoId,
				t_emp_contract_info.contract_type type,
				t_emp_contract_info.contract_period period,
				t_emp_contract.contract_style style,
				t_emp_contract_info.contract_start_date startDate,
				t_emp_contract_info.contract_end_date endDate,
				<#if fields?? && fields?size gt 0>
					<#list fields as field>
							${field} ,
					</#list>
				</#if> 
				if(t_emp_contract.status!=0,t_emp_contract.status,t_emp_contract_info.status) status
			FROM
				t_emp_contract 
			LEFT JOIN
				t_emp_contract_info  ON t_emp_contract_info.contract_id = t_emp_contract.id
			<#if infoId?? && infoId?length gt 0>
				and t_emp_contract_info.id = :infoId
			<#else>
				and t_emp_contract.sign_num = t_emp_contract_info.status
			</#if> 
			left join t_ext_t_contract on t_ext_t_contract.id = t_emp_contract.id
			LEFT JOIN wec_user u ON u.id = t_emp_contract.user_id
			left join t_emp_contract_dissolution  on t_emp_contract_dissolution.contract_id=t_emp_contract.id
			left join t_organ t on t.id=u.organ_id
			left join t_gangwei tg on u.gangwei_id=tg.id and u.gangwei_id is not null
			left join t_zhiwei tz on tz.id=u.zhiwei_id and u.zhiwei_id is not null
			WHERE
				t_emp_contract.id = :contractId  
			AND t_emp_contract. STATUS != 5
		]]>
    </sql>


    <sql id="getContractListPage" isRead="true">
        <![CDATA[

				SELECT
				c.id,
				u.emp_no empNo,
				u.user_name userName,
				o.id organId,
				g.gangwei_name gangweiName,
				c.code_num codeNum,
				c.contract_style contractStyle,
				c.sign_num signNum,
				c.biz_type bizType,
				if(c.audit_status is null,0,1) auditStatus,
				if(c.`status` = 0,info.status,c.status) status,
				info.contract_type contractType,
				info.contract_period contractPeriod,
				info.contract_start_date startDate,
				info.contract_end_date endDate,
				info.contract_stop_date stopDate,
				if(c.status=0,0,1) youxiao,
				u2.user_name updateUserName,
				ifnull(info.update_date,info.create_date) updateDate
			<#if selfFields??  && selfFields?size gt 0>
				,
            	<#list selfFields as selfField>
           		 	ext.${selfField}
           		 	<#if selfField_has_next>,</#if>
        		</#list>
       		</#if>
			FROM
				t_emp_contract c
			LEFT JOIN t_emp_contract_info info ON info.contract_id = c.id and info.status = c.sign_num AND info.`status` != 5
			LEFT JOIN wec_user u ON u.id = c.user_id
			LEFT JOIN t_gangwei g ON g.id = u.gangwei_id
			LEFT JOIN t_organ o ON o.id = u.organ_id
			LEFT JOIN t_ext_t_contract ext on ext.id = c.id
			LEFT JOIN wec_user u2 ON u2.id = ifnull(info.update_uid,info.create_uid)
			WHERE
				c.company_id = :companyId
				AND c.`status` != 5
			<#if organPaths?? && organPaths?length gt 0>
				AND o.organ_paths like CONCAT (:organPaths,'%')
			</#if>
			<#if filterStr?? && filterStr?length gt 0>
				and (
				u.user_name like concat('%',:filterStr,'%')
				or
				u.emp_no like concat('%',:filterStr,'%')
				or
				g.gangwei_name like concat('%',:filterStr,'%')
				or
				o.organ_name like concat('%',:filterStr,'%')
				)
			</#if>
			<#if dataRange??  && dataRange?length gt 0>
            	${dataRange}
        	</#if>
			<#if tabId?? && tabId?length gt 0>
				<#if tabId == 3>
					and info.contract_end_date is not null
					and TO_DAYS(info.contract_end_date) < TO_DAYS(NOW())
				</#if>
				<#if tabId == 4>
					and info.contract_end_date is not null
					and TO_DAYS(info.contract_end_date) >= TO_DAYS(NOW())
					and (TO_DAYS(info.contract_end_date) - TO_DAYS(NOW())) <= 30
				</#if>
			</#if>
		<#if functions??  && functions?size gt 0>
				and (
            	<#list functions as thisfunc>
            		<#if thisfunc??  && thisfunc?size gt 0>
	           		 	(
	           		 	<#list thisfunc as selffunc>
	           		 			${selffunc.sqlStr}  
	           		 			 	<#if selffunc.funcType??  && selffunc.funcType?length gt 0> 
	           		 			 		<#if selffunc.funcType = 0>
	           		 			 			<
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 1>
	           		 			 			=
	           		 			 		</#if> 
	           		 			 		<#if selffunc.funcType = 2>
	           		 			 			>
	           		 			 		</#if> 
	           		 			 	<#else>
	           		 			 	 like
									</#if>  
	           		 			'${selffunc.funcValue}'
	           		 		<#if selffunc_has_next> and</#if>
	           		 	</#list>	           		 		           	       
           		 		)
           		 		<#if thisfunc_has_next> or </#if>
           		 	</#if>          		 	
        		</#list>
        		)
       		</#if>
		order by info.create_date desc
		]]>
    </sql>

    <sql id="getContractListPageH5" isRead="true">
        <![CDATA[
			SELECT
			u.id,
			u.emp_no empNo,
			u.user_name userName,
			u.user_status userStatus,
			u.status,
			u.phone,
			u.organ_id organId,
			u.gangwei_id gangweiId,
			u.entry_date,
			to_days(now())-to_days(u.entry_date) entryDays,
			g.gangwei_name gangweiName,
			o.organ_name organName,
			g.zhiwei_id zhiweiId,
			z.zhiwei_name zhiweiName,
			ec.id contractId,
			ec.status contractStatus,
			eci.contract_end_date contractEndDate,
			if(eci.contract_end_date is not null,to_days(now()) - to_days(eci.contract_end_date),-1) expiredDays,
			eci.contract_stop_date contractStopDate,
			dissolution.id dissolutionId,
			dissolution.dissolution_date dissolutionDate,
			dissolution.dissolution_type dissolutionType,
			dissolution.penalty,
			dissolution.penalty_type penaltyType,
			dissolution.description,
			termination.id terminationId
			FROM
				wec_user u
			LEFT JOIN t_organ o ON o.id = u.organ_id
			LEFT JOIN t_gangwei g ON u.gangwei_id = g.id
			LEFT JOIN t_zhiwei z ON g.zhiwei_id = z.id
			LEFT JOIN (SELECT * FROM t_emp_contract ORDER BY sign_num DESC) ec ON u.id = ec.user_id AND ec.status != 5
			LEFT JOIN t_emp_contract_info eci ON ec.id = eci.contract_id AND eci.status = ec.sign_num
			LEFT JOIN t_emp_contract_dissolution dissolution ON ec.id = dissolution.contract_id
			LEFT JOIN t_emp_contract_termination termination ON ec.id = termination.contract_id
			WHERE
			u.company_id = :companyId
			<#if tabId??  && tabId = 0>
			 	AND	u.`status` not in ('3','5') AND u.user_status not in ('40','50')
				AND (ec.id IS NULL 
					OR 
					(ec.id IS NOT NULL AND ec.`status` = 0 AND eci.contract_end_date IS NOT NULL AND to_days(eci.contract_end_date) - to_days(NOW()) <= 0)
					)
			</#if>
			<#if tabId??  && tabId = 1>
				<#if organId?? && organId?length gt 0>
					AND u.organ_id = :organId
				</#if>
				<#if key??  && key?length gt 0>
		           	AND (
					o.organ_name LIKE CONCAT('%', :key, '%')
					OR g.gangwei_name LIKE CONCAT('%', :key, '%')
					OR u.user_name LIKE CONCAT('%', :key, '%')
					)
		       	</#if>
				<#if userName?? && userName?length gt 0>
					AND u.id = :userName
				</#if>
				<#if contractStyle?? && contractStyle?length gt 0>
					AND ec.contract_style = :contractStyle
				</#if>
				<#if contractStatus?? && contractStatus?length gt 0>
					<#if contractStatus = 0>
						AND (
							(ec.id IS NOT NULL AND ec.sign_num = 3)	
							OR
							(ec.id IS NOT NULL AND eci.contract_end_date IS NOT NULL AND to_days(eci.contract_end_date) - to_days(NOW()) >= 0)
							OR 
							(ec.id IS NOT NULL AND ec.`status` != 0 AND eci.contract_end_date IS NOT NULL AND to_days(eci.contract_end_date) - to_days(NOW()) < 0)
							OR
							(ec.id IS NOT NULL AND eci.contract_type != 1)
							)
					</#if>
					<#if contractStatus = 1>
						AND u.`status` NOT IN ('3','5') AND u.user_status NOT IN ('40','50') AND
						u.id NOT IN (SELECT user_id FROM t_emp_contract WHERE `status` = 0 AND company_id = :companyId)
					</#if>
					<#if contractStatus = 2>
						AND eci.contract_end_date IS NOT NULL AND to_days(eci.contract_end_date) - to_days(NOW()) < 0
					</#if>
				</#if>
				<#if contractStartDate?? && contractStartDate?length gt 0>
					AND eci.contract_start_date = :contractStartDate
				</#if>
				<#if contractEndDate?? && contractEndDate?length gt 0>
					AND eci.contract_end_date = :contractEndDate
				</#if>
			</#if>
			<#if organPaths?? && organPaths?length gt 0>
				AND o.organ_paths like CONCAT (:organPaths,'%')
			</#if>
			<#if dataRange??  && dataRange?length gt 0>
            	${dataRange}
        	</#if>
        	GROUP BY u.id,ec.contract_style
		]]>
    </sql>
    <sql id="getUserContractListPageH5" isRead="true">
        <![CDATA[
			SELECT
			u.id,
			u.emp_no empNo,
			u.user_name userName,
			u.user_status userStatus,
			u.status,
			u.phone,
			u.organ_id organId,
			u.gangwei_id gangweiId,
			u.entry_date,
			TO_DAYS(NOW())- TO_DAYS(u.entry_date) entryDays,
			g.gangwei_name gangweiName,
			o.organ_name organName,
			g.zhiwei_id zhiweiId,
			z.zhiwei_name zhiweiName,
			ec.id contractId,
			ec.status contractStatus,
			ec.code_num codeNum,
			ec.contract_style contractStyle,
			eci.id contractInfoId,
			eci.status contractInfoStatus,
			eci.contract_type contractType,
			eci.contract_start_date contractStartDate,
			eci.contract_end_date contractEndDate,
			IF(eci.contract_end_date IS NOT NULL, TO_DAYS(NOW()) - TO_DAYS(eci.contract_end_date),-1) expiredDays,
			eci.contract_stop_date contractStopDate,
			dissolution.id dissolutionId,
			dissolution.dissolution_date dissolutionDate,
			dissolution.dissolution_type dissolutionType,
			dissolution.penalty,
			dissolution.penalty_type penaltyType,
			dissolution.description,
			termination.id terminationId
			FROM
				wec_user u
			LEFT JOIN t_organ o ON o.id = u.organ_id
			LEFT JOIN t_gangwei g ON u.gangwei_id = g.id
			LEFT JOIN t_zhiwei z ON g.zhiwei_id = z.id
			LEFT JOIN t_emp_contract ec ON u.id = ec.user_id
			LEFT JOIN t_emp_contract_info eci ON ec.id = eci.contract_id
			LEFT JOIN t_emp_contract_dissolution dissolution ON ec.id = dissolution.contract_id
			LEFT JOIN t_emp_contract_termination termination ON ec.id = termination.contract_id
			WHERE
			u.company_id = :companyId
			AND ec.status != 5
			AND eci.status = ec.sign_num
			AND u.STATUS IN ('0', '2')
			<#if userId?? && userId?length gt 0>
				AND u.id = :userId
			</#if>
			GROUP BY ec.id
			ORDER BY eci.create_date DESC
		]]>
    </sql>

    <!-- 查询未签人员 -->
    <sql id="getNoSignUsersH5" isRead="true">
        <![CDATA[
			SELECT
				u.id,
				u.user_name userName,
				u.emp_no empNo,
				u.organ_id organId,
				g.gangwei_name gangweiName,
				z.zhiwei_name zhiweiName,
				u.entry_date entryDate,
				u.`user_status` userStatus,
				u.`entry_shop_date` entryShopDate
			FROM
				wec_user u
			LEFT JOIN t_gangwei g ON g.id = u.gangwei_id
			LEFT JOIN t_zhiwei z ON z.id = g.zhiwei_id
			LEFT JOIN t_organ o ON o.id = u.organ_id
			WHERE
				u.company_id = :companyId
				AND u.`status` not in ('3','5') 
				AND u.user_status NOT IN ('40','50')
				AND u.id NOT IN (SELECT user_id FROM t_emp_contract WHERE `status` = 0 AND company_id = :companyId)
				<#if key??  && key?length gt 0>
	           	AND (
					o.organ_name LIKE CONCAT('%', :key, '%')
					OR g.gangwei_name LIKE CONCAT('%', :key, '%')
					OR u.user_name LIKE CONCAT('%', :key, '%')
					)
		   		</#if>
				<#if dataRange??  && dataRange?length gt 0>
		           	${dataRange}
		        </#if>
		]]>
    </sql>

    <!-- 待办列表 -->
    <sql id="getTodoContractPageH5" isRead="true">
        <![CDATA[
        SELECT  mynt.*, 
				CASE 
					WHEN mynt.expiredDays < 0 THEN <#if sortFlag?? && sortFlag==1>0<#else>1</#if>
					WHEN mynt.expiredDays > 0 THEN <#if sortFlag?? && sortFlag==2>0<#else>2</#if>
					WHEN mynt.contractId IS NULL THEN <#if sortFlag?? && sortFlag==3>0<#else>3</#if>
					ELSE 9999 
				END sort
			FROM 
				(SELECT
				u.id,
				u.emp_no empNo,
				u.user_name userName,
				u.user_status userStatus,
				u.status,
				u.phone,
				u.organ_id organId,
				u.gangwei_id gangweiId,
				u.entry_date,
				TO_DAYS(NOW())-TO_DAYS(u.entry_date) entryDays,
				g.gangwei_name gangweiName,
				o.organ_name organName,
				g.zhiwei_id zhiweiId,
				z.zhiwei_name zhiweiName,
				ec.id contractId,
				eci.id contractInfoId,
				eci.status contractInfoStatus,
				eci.contract_end_date contractEndDate,
				if(eci.contract_end_date IS NOT NULL,TO_DAYS(eci.contract_end_date) - TO_DAYS(NOW()) ,66) expiredDays,
				eci.contract_stop_date contractStopDate
				FROM
					wec_user u
				LEFT JOIN t_organ o ON o.id = u.organ_id
				LEFT JOIN t_gangwei g ON u.gangwei_id = g.id
				LEFT JOIN t_zhiwei z ON g.zhiwei_id = z.id
				LEFT JOIN t_emp_contract ec ON u.id = ec.user_id
				LEFT JOIN t_emp_contract_info eci ON ec.id = eci.contract_id AND eci.status = ec.sign_num 
				WHERE
				u.company_id = :companyId
				AND (ec.`status` IS NULL OR ec.`status` = 0)
				<#if contractStatus?? && contractStatus == 1>
					AND (
							u.`status` not in ('3','5') AND u.user_status not in ('40','50') AND
							u.id NOT IN (SELECT user_id FROM t_emp_contract WHERE `status` = 0 AND company_id = :companyId)
						)
				<#elseif contractStatus?? && contractStatus == 2>
					AND eci.contract_end_date IS NOT NULL AND (to_days(eci.contract_end_date) - to_days(NOW()) <= 30)
					AND (to_days(eci.contract_end_date) - to_days(NOW()) >=0)
				<#elseif contractStatus?? && contractStatus == 3>
					AND eci.contract_end_date IS NOT NULL AND (to_days(eci.contract_end_date) - to_days(NOW()) < 0)
				<#else>
					AND(
							(
								u.`status` not in ('3','5') AND u.user_status not in ('40','50') AND
								u.id NOT IN (SELECT user_id FROM t_emp_contract WHERE `status` = 0 AND company_id = :companyId)
							)
							OR 
							( 
							   eci.contract_end_date IS NOT NULL AND to_days(eci.contract_end_date) - to_days(NOW()) <= 30
							)
						)
				</#if>
				<#if contractStyle?? && contractStyle gt 0>
					AND ec.contract_style = :contractStyle
				</#if>
				<#if key??  && key?length gt 0>
		           	AND (
					o.organ_name LIKE CONCAT('%', :key, '%')
					OR g.gangwei_name LIKE CONCAT('%', :key, '%')
					OR u.user_name LIKE CONCAT('%', :key, '%')
					)
			    </#if>
				<#if dataRange??  && dataRange?length gt 0>
	            	${dataRange}
	        	</#if>
        	) mynt
        	ORDER BY sort ASC,mynt.expiredDays ASC
		]]>
    </sql>



    <!-- 查询最新的审批记录 -->
    <sql id="getLastAudit" isRead="true">
        <![CDATA[
        SELECT
        *
        FROM
        t_contract_audit_record t
        WHERE contract_id =:contractId
        ORDER BY t.`create_date` DESC
        LIMIT 1
        ]]>
    </sql>

</sqlMap>